import{T as f,F as n,p as I,G as o,m as A,i as s,M as r,d,$ as a,_ as P,k as p,b as g,t as L}from"./index--BqaKNiR.js";f.calibration={};f.calibration.model=(function(){var i={},l={};return l.step=null,i.next=function(){if(l.step===null)l.step=1;else{for(var u=0,b=0;b<6;b++)n.CALIBRATION_DATA.acc["Pos"+b]===1&&u++;l.step=u}return console.log(l.step),l.step>5&&(l.step=null),l.step},i.getStep=function(){return l.step},i})();f.calibration.initialize=function(i){var l=new I,u=new I,b,_,C;o.active_tab!="calibration"&&(o.active_tab="calibration"),l.setChain([A.queryFcStatus,A.loadSensorConfig,A.loadCalibrationData]),l.setExitPoint(T),l.execute(),u.setChain([A.saveCalibrationData,A.saveToEeprom]),u.setExitPoint(S);function S(){o.log(s.getMessage("configurationEepromSaved")),o.tab_switch_cleanup(function(){r.send_message(d.MSP_SET_REBOOT,!1,!1,O)})}function O(){o.log(s.getMessage("deviceRebooting")),o.handleReconnect(a(".tab_calibration a"))}function T(){P(async()=>{const{default:t}=await import("./calibration-ge0y_L8V.js");return{default:t}},[],import.meta.url).then(({default:t})=>o.load(t,N))}function v(){for(var t=0;t<6;t++){var e=a('[data-step="'+(t+1)+'"]');n.CALIBRATION_DATA.acc["Pos"+t]===0?e.removeClass("finished").removeClass("active"):e.addClass("finished").removeClass("active")}}function m(){var t=["X","Y","Z"];t.forEach(function(e){a("[name=accGain"+e+"]").val(n.CALIBRATION_DATA.accGain[e]),a("[name=accZero"+e+"]").val(n.CALIBRATION_DATA.accZero[e]),a("[name=Mag"+e+"]").val(n.CALIBRATION_DATA.magZero[e]),a("[name=MagGain"+e+"]").val(n.CALIBRATION_DATA.magGain[e])}),a("[name=OpflowScale]").val(n.CALIBRATION_DATA.opflow.Scale),v()}function h(){f.calibration.model.next()===null&&(_=new p("Modal",{width:400,height:200,animation:!1,closeOnClick:!1,closeOnEsc:!1,content:a("#modal-acc-calibration-stop")}).open()),m()}function w(){var t=null,e=a(this);if(f.calibration.model.getStep()===null){for(var c=0;c<6;c++)n.CALIBRATION_DATA.acc["Pos"+c]===1&&(n.CALIBRATION_DATA.acc["Pos"+c]=0);v(),b=new p("Modal",{width:400,height:200,animation:!1,closeOnClick:!1,closeOnEsc:!1,content:a("#modal-acc-calibration-start")}).open()}else t=f.calibration.model.next();t!==null&&(e.addClass("disabled"),C=new p("Modal",{width:400,height:120,animation:!1,closeOnClick:!1,closeOnEsc:!1,content:a("#modal-acc-processing")}).open(),r.send_message(d.MSP_ACC_CALIBRATION,!1,!1,function(){o.log(s.getMessage("initialSetupAccelCalibStarted"))}),L.add("acc_calibration_timeout",function(){e.removeClass("disabled"),C.close(),r.send_message(d.MSP_CALIBRATION_DATA,!1,!1,h),o.log(s.getMessage("initialSetupAccelCalibEnded"))},2e3))}function M(t){n.getAccelerometerCalibrated()?(a("#calibrate-start-button").html(s.getMessage("AccResetBtn")),a("#calibrate-start-button").prop("title",s.getMessage("AccResetBtn")),a("#calibrate-start-button").removeClass("calibrate"),a("#calibrate-start-button").addClass("resetCalibration")):(a("#calibrate-start-button").html(s.getMessage("AccBtn")),a("#calibrate-start-button").prop("title",s.getMessage("AccBtn")),a("#calibrate-start-button").addClass("calibrate"),a("#calibrate-start-button").removeClass("resetCalibration"))}function B(t){a("#calibrate-start-button").hasClass("resetCalibration")?R():w()}function R(){var t=["X","Y","Z"];t.forEach(function(e){n.CALIBRATION_DATA.accGain[e]=4096,n.CALIBRATION_DATA.accZero[e]=0}),u.execute()}function N(){a("#calibrateButtonSave").on("click",function(){n.CALIBRATION_DATA.opflow.Scale=parseFloat(a("[name=OpflowScale]").val()),u.execute()}),n.SENSOR_CONFIG.magnetometer===0&&a("#mag_btn, #mag-calibrated-data").css("pointer-events","none").css("opacity","0.4"),n.SENSOR_CONFIG.opflow===0&&a("#opflow_btn, #opflow-calibrated-data").css("pointer-events","none").css("opacity","0.4"),a("#mag_btn").on("click",function(){r.send_message(d.MSP_MAG_CALIBRATION,!1,!1,function(){o.log(s.getMessage("initialSetupMagCalibStarted"))});var t=a(this);a(t).addClass("disabled");let e=new p("Modal",{width:400,height:120,animation:!1,closeOnClick:!1,closeOnEsc:!1,content:a("#modal-compass-processing").clone()}).open();var c=30;g.add("compass_calibration_interval",function(){c--,c===0?setTimeout(function(){a(t).removeClass("disabled"),e.close(),o.log(s.getMessage("initialSetupMagCalibEnded")),r.send_message(d.MSP_CALIBRATION_DATA,!1,!1,m),g.remove("compass_calibration_interval"),a(".jBox-wrapper").remove()},1e3):e.content.find(".modal-compass-countdown").text(c)},1e3)}),a("#opflow_btn").on("click",function(){r.send_message(d.MSP2_INAV_OPFLOW_CALIBRATION,!1,!1,function(){o.log(s.getMessage("initialSetupOpflowCalibStarted"))});var t=a(this);a(t).addClass("disabled"),C=new p("Modal",{width:400,height:120,animation:!1,closeOnClick:!1,closeOnEsc:!1,content:a("#modal-opflow-processing")}).open();var e=30;g.add("opflow_calibration_interval",function(){e--,a("#modal-opflow-countdown").text(e),e===0&&(a(t).removeClass("disabled"),C.close(),o.log(s.getMessage("initialSetupOpflowCalibEnded")),r.send_message(d.MSP_CALIBRATION_DATA,!1,!1,m),g.remove("opflow_calibration_interval"))},1e3)}),a("#modal-start-button").on("click",function(){b.close(),f.calibration.model.next()}),a("#modal-stop-button").on("click",function(){_.close()}),s.localize(),M(),a("#calibrate-start-button").on("click",B),r.send_message(d.MSP_CALIBRATION_DATA,!1,!1,m),o.content_ready(i)}};f.calibration.cleanup=function(i){i&&i()};
