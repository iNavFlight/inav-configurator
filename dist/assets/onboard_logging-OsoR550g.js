import{T as h,G as r,C as B,M as l,d as c,_ as j,i as m,F as n,B as J,$ as e,x as f,m as p}from"./index--BqaKNiR.js";var _;h.onboard_logging={};h.onboard_logging.initialize=function(A){let S,D;const u=["BLACKBOX_FEATURE_NAV_ACC","BLACKBOX_FEATURE_NAV_POS","BLACKBOX_FEATURE_NAV_PID","BLACKBOX_FEATURE_MAG","BLACKBOX_FEATURE_ACC","BLACKBOX_FEATURE_ATTITUDE","BLACKBOX_FEATURE_RC_DATA","BLACKBOX_FEATURE_RC_COMMAND","BLACKBOX_FEATURE_MOTORS","BLACKBOX_FEATURE_GYRO_RAW","BLACKBOX_FEATURE_GYRO_PEAKS_ROLL","BLACKBOX_FEATURE_GYRO_PEAKS_PITCH","BLACKBOX_FEATURE_GYRO_PEAKS_YAW","BLACKBOX_FEATURE_SERVOS"];r.active_tab!="onboard_logging"&&(r.active_tab="onboard_logging"),B.connectionValid&&l.send_message(c.MSP_FEATURE,!1,!1,function(){l.send_message(c.MSP_DATAFLASH_SUMMARY,!1,!1,function(){l.send_message(c.MSP_SDCARD_SUMMARY,!1,!1,function(){l.send_message(c.MSP2_BLACKBOX_CONFIG,!1,!1,U)})})});function E(a,t){return t==0?a:E(t,a%t)}function F(){l.send_message(c.MSP_EEPROM_WRITE,!1,!1,M)}function M(){r.log(m.getMessage("configurationEepromSaved")),r.tab_switch_cleanup(function(){l.send_message(c.MSP_SET_REBOOT,!1,!1,X)})}function X(){r.log(m.getMessage("deviceRebooting")),r.handleReconnect(e(".tab_onboard_logging a"))}function U(){j(async()=>{const{default:a}=await import("./onboard_logging-B7ZMh_6k.js");return{default:a}},[],import.meta.url).then(({default:a})=>r.load(a,function(){m.localize();var t=n.DATAFLASH.totalSize>0,s=!1;(n.BLACKBOX.supported||n.DATAFLASH.supported)&&J.bit_check(n.FEATURES,19)&&(s=!0),e(".tab-onboard_logging").addClass("serial-supported").toggleClass("dataflash-supported",n.DATAFLASH.supported).toggleClass("dataflash-present",t).toggleClass("sdcard-supported",n.SDCARD.supported).toggleClass("blackbox-config-supported",n.BLACKBOX.supported).toggleClass("blackbox-supported",s).toggleClass("blackbox-unsupported",!s),t&&(e(".tab-onboard_logging a.erase-flash").on("click",Y),e(".tab-onboard_logging a.erase-flash-confirm").on("click",G),e(".tab-onboard_logging a.erase-flash-cancel").on("click",V),e(".tab-onboard_logging a.save-flash").on("click",N),e(".tab-onboard_logging a.save-flash-cancel").on("click",H),e(".tab-onboard_logging a.save-flash-dismiss").on("click",L)),e(".save-blackbox-feature").on("click",function(){f.reset(),f.fromUI(e(".require-blackbox-unsupported")),f.execute(F)}),n.BLACKBOX.supported&&e(".tab-onboard_logging a.save-settings").on("click",function(){var i=e(".blackboxRate select").val().split("/");n.BLACKBOX.blackboxRateNum=parseInt(i[0],10),n.BLACKBOX.blackboxRateDenom=parseInt(i[1],10),n.BLACKBOX.blackboxDevice=parseInt(e(".blackboxDevice select").val(),10),n.BLACKBOX.blackboxIncludeFlags=W(),f.reset(),f.fromUI(e(".require-blackbox-supported")),f.execute(function(){p.sendBlackboxConfiguration(F)})});const d=e("#blackBoxFlagsDiv");for(let i=0;i<u.length;i++){const o=u[i],q=(n.BLACKBOX.blackboxIncludeFlags&1<<i)!==0,R=e('<input type="checkbox" class="toggle feature" />');R.attr("id",o),R.attr("checked",q);const T=e("<label></label>");T.attr("for",o);const K=e("<span></span>");K.html(m.getMessage(o)),T.append(K);const $=e('<div class="checkbox"></div>').append([R,T]);d.append($)}P(),I(),C(),r.content_ready(A)}))}function I(){var a=e(".blackboxDevice select").empty();a.append('<option value="0">Serial port</option>'),n.DATAFLASH.ready&&a.append('<option value="1">On-board dataflash chip</option>'),n.SDCARD.supported&&a.append('<option value="2">On-board SD card slot</option>'),a.val(n.BLACKBOX.blackboxDevice)}function P(){for(var a=E(n.BLACKBOX.blackboxRateNum,n.BLACKBOX.blackboxRateDenom),t={num:n.BLACKBOX.blackboxRateNum/a,denom:n.BLACKBOX.blackboxRateDenom/a},s=[{num:1,denom:32},{num:1,denom:16},{num:1,denom:8},{num:1,denom:5},{num:1,denom:4},{num:1,denom:3},{num:1,denom:2},{num:2,denom:3},{num:3,denom:4},{num:4,denom:5},{num:7,denom:8},{num:1,denom:1}],d=e(".blackboxRate select"),i=!1,o=0;o<s.length;o++)!i&&t.num/t.denom<=s[o].num/s[o].denom&&(t.num/t.denom<s[o].num/s[o].denom&&d.append('<option value="'+t.num+"/"+t.denom+'">'+t.num+"/"+t.denom+" ("+Math.round(t.num/t.denom*100)+"%)</option>"),i=!0),d.append('<option value="'+s[o].num+"/"+s[o].denom+'">'+s[o].num+"/"+s[o].denom+" ("+Math.round(s[o].num/s[o].denom*100)+"%)</option>");d.val(t.num+"/"+t.denom)}function v(a){if(a<1024)return Math.round(a)+"kB";var t=a/1024,s;return t<900?t.toFixed(1)+"MB":(s=t/1024,s.toFixed(1)+"GB")}function z(a){return a<1024?a+"B":v(a/1024)}function b(a,t,s,d,i){t>0?(a.css({width:t/s*100+"%",display:"block"}),e("div",a).text((d?d+" ":"")+(i?v(t):z(t)))):a.css({display:"none"})}function C(){switch(b(e(".tab-onboard_logging .dataflash-used"),n.DATAFLASH.usedSize,n.DATAFLASH.totalSize,"Used space",!1),b(e(".tab-onboard_logging .dataflash-free"),n.DATAFLASH.totalSize-n.DATAFLASH.usedSize,n.DATAFLASH.totalSize,"Free space",!1),b(e(".tab-onboard_logging .sdcard-other"),n.SDCARD.totalSizeKB-n.SDCARD.freeSizeKB,n.SDCARD.totalSizeKB,"Unavailable space",!0),b(e(".tab-onboard_logging .sdcard-free"),n.SDCARD.freeSizeKB,n.SDCARD.totalSizeKB,"Free space for logs",!0),e(".btn a.erase-flash, .btn a.save-flash").toggleClass("disabled",n.DATAFLASH.usedSize==0),e(".tab-onboard_logging").toggleClass("sdcard-error",n.SDCARD.state==l.SDCARD_STATE_FATAL).toggleClass("sdcard-initializing",n.SDCARD.state==l.SDCARD_STATE_CARD_INIT||n.SDCARD.state==l.SDCARD_STATE_FS_INIT).toggleClass("sdcard-ready",n.SDCARD.state==l.SDCARD_STATE_READY),n.SDCARD.state){case l.SDCARD_STATE_NOT_PRESENT:e(".sdcard-status").text("No card inserted");break;case l.SDCARD_STATE_FATAL:e(".sdcard-status").html("Fatal error<br>Reboot to retry");break;case l.SDCARD_STATE_READY:e(".sdcard-status").text("Card ready");break;case l.SDCARD_STATE_CARD_INIT:e(".sdcard-status").text("Card starting...");break;case l.SDCARD_STATE_FS_INIT:e(".sdcard-status").text("Filesystem starting...");break;default:e(".sdcard-status").text("Unknown state "+n.SDCARD.state)}n.SDCARD.supported&&!_&&(_=setTimeout(function(){_=!1,B.connectionValid&&l.send_message(c.MSP_SDCARD_SUMMARY,!1,!1,function(){C()})},2e3))}function g(a,t){for(a=""+a;a.length<t;)a="0"+a;return a}function H(){S=!0}function y(){e(".dataflash-saving progress").attr("value",0),S=!1,e(".dataflash-saving").removeClass("done"),e(".dataflash-saving")[0].showModal()}function L(){e(".dataflash-saving")[0].close()}function k(){e(".dataflash-saving").addClass("done")}function O(a){l.send_message(c.MSP_DATAFLASH_SUMMARY,!1,!1,function(){C(),a&&a()})}function N(){r.connected_to&&O(function(){const a=n.DATAFLASH.usedSize;w(function(t){let s=0;y();function d(i,o){o!=null?o.byteLength>0?(s+=o.byteLength,e(".dataflash-saving progress").attr("value",s/a*100),fs.writeFileSync(t,new Uint8Array(o),{flag:"a"}),S?L():s>=a?k():p.dataflashRead(s,d)):k():p.dataflashRead(s,d)}p.dataflashRead(s,d)})})}function w(a){const t=new Date;var d={defaultPath:"blackbox_log_"+t.getFullYear()+"-"+g(t.getMonth()+1,2)+"-"+g(t.getDate(),2)+"_"+g(t.getHours(),2)+g(t.getMinutes(),2)+g(t.getSeconds(),2)+".TXT",filters:[{name:"TXT file",extensions:["txt"]}]};dialog.showSaveDialog(d).then(i=>{i.canceled||a(i.filePath)})}function Y(){D=!1,e(".dataflash-confirm-erase").removeClass("erasing"),e(".dataflash-confirm-erase")[0].showModal()}function x(){O(function(){B.connectionValid&&!D&&(n.DATAFLASH.ready?e(".dataflash-confirm-erase")[0].close():setTimeout(x,500))})}function G(){e(".dataflash-confirm-erase").addClass("erasing"),l.send_message(c.MSP_DATAFLASH_ERASE,!1,!1,x)}function V(){D=!0,e(".dataflash-confirm-erase")[0].close()}function W(){let a=0;for(let t=0;t<u.length;t++){const s=u[t];e("#"+s).prop("checked")&&(a=a|1<<t)}return a}};h.onboard_logging.cleanup=function(A){_&&(clearTimeout(_),_=!1),A&&A()};
