import{T as v,G as m,i as x,C as $,P as he,u as Oe,a as Je,$ as l,b as Q,_ as et,s as _e,c as O,S as tt,t as we,F as X,M as J,d as ae,m as rt,e as xe,f as st}from"./index--BqaKNiR.js";import{d as Re}from"./dialog-CY10jn-b.js";function Se(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var te=Se();function Ne(t){te=t}var ie={exec:()=>null};function D(t,e=""){let s=typeof t=="string"?t:t.source,n={replace:(r,a)=>{let i=typeof a=="string"?a:a.source;return i=i.replace(N.caret,"$1"),s=s.replace(r,i),n},getRegex:()=>new RegExp(s,e)};return n}var N={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:t=>new RegExp(`^( {0,3}${t})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}#`),htmlBeginRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}<(?:[a-z].*>|!--)`,"i")},nt=/^(?:[ \t]*(?:\n|$))+/,at=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,it=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,oe=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,ot=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Te=/(?:[*+-]|\d{1,9}[.)])/,Be=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,qe=D(Be).replace(/bull/g,Te).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),lt=D(Be).replace(/bull/g,Te).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),ye=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,ct=/^[^\n]+/,Ae=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,ut=D(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Ae).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),ht=D(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Te).getRegex(),de="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Ee=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,ft=D("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Ee).replace("tag",de).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Ge=D(ye).replace("hr",oe).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",de).getRegex(),pt=D(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Ge).getRegex(),Fe={blockquote:pt,code:at,def:ut,fences:it,heading:ot,hr:oe,html:ft,lheading:qe,list:ht,newline:nt,paragraph:Ge,table:ie,text:ct},Me=D("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",oe).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",de).getRegex(),gt={...Fe,lheading:lt,table:Me,paragraph:D(ye).replace("hr",oe).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Me).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",de).getRegex()},dt={...Fe,html:D(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Ee).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:ie,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:D(ye).replace("hr",oe).replace("heading",` *#{1,6} *[^
]`).replace("lheading",qe).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},mt=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,xt=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,He=/^( {2,}|\\)\n(?!\s*$)/,_t=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,me=/[\p{P}\p{S}]/u,De=/[\s\p{P}\p{S}]/u,Ve=/[^\s\p{P}\p{S}]/u,vt=D(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,De).getRegex(),Ke=/(?!~)[\p{P}\p{S}]/u,bt=/(?!~)[\s\p{P}\p{S}]/u,kt=/(?:[^\s\p{P}\p{S}]|~)/u,wt=/\[[^\[\]]*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)|`[^`]*?`|<(?! )[^<>]*?>/g,Ye=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,St=D(Ye,"u").replace(/punct/g,me).getRegex(),Tt=D(Ye,"u").replace(/punct/g,Ke).getRegex(),Ze="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",yt=D(Ze,"gu").replace(/notPunctSpace/g,Ve).replace(/punctSpace/g,De).replace(/punct/g,me).getRegex(),At=D(Ze,"gu").replace(/notPunctSpace/g,kt).replace(/punctSpace/g,bt).replace(/punct/g,Ke).getRegex(),Et=D("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Ve).replace(/punctSpace/g,De).replace(/punct/g,me).getRegex(),Ft=D(/\\(punct)/,"gu").replace(/punct/g,me).getRegex(),Dt=D(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Ct=D(Ee).replace("(?:-->|$)","-->").getRegex(),Lt=D("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Ct).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),fe=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`[^`]*`|[^\[\]\\`])*?/,It=D(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",fe).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),Qe=D(/^!?\[(label)\]\[(ref)\]/).replace("label",fe).replace("ref",Ae).getRegex(),We=D(/^!?\[(ref)\](?:\[\])?/).replace("ref",Ae).getRegex(),Rt=D("reflink|nolink(?!\\()","g").replace("reflink",Qe).replace("nolink",We).getRegex(),Ce={_backpedal:ie,anyPunctuation:Ft,autolink:Dt,blockSkip:wt,br:He,code:xt,del:ie,emStrongLDelim:St,emStrongRDelimAst:yt,emStrongRDelimUnd:Et,escape:mt,link:It,nolink:We,punctuation:vt,reflink:Qe,reflinkSearch:Rt,tag:Lt,text:_t,url:ie},Mt={...Ce,link:D(/^!?\[(label)\]\((.*?)\)/).replace("label",fe).getRegex(),reflink:D(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",fe).getRegex()},ve={...Ce,emStrongRDelimAst:At,emStrongLDelim:Tt,url:D(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},zt={...ve,br:D(He).replace("{2,}","*").getRegex(),text:D(ve.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},ce={normal:Fe,gfm:gt,pedantic:dt},se={normal:Ce,gfm:ve,breaks:zt,pedantic:Mt},Pt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},ze=t=>Pt[t];function Y(t,e){if(e){if(N.escapeTest.test(t))return t.replace(N.escapeReplace,ze)}else if(N.escapeTestNoEncode.test(t))return t.replace(N.escapeReplaceNoEncode,ze);return t}function Pe(t){try{t=encodeURI(t).replace(N.percentDecode,"%")}catch{return null}return t}function $e(t,e){let s=t.replace(N.findPipe,(a,i,o)=>{let c=!1,h=i;for(;--h>=0&&o[h]==="\\";)c=!c;return c?"|":" |"}),n=s.split(N.splitPipe),r=0;if(n[0].trim()||n.shift(),n.length>0&&!n.at(-1)?.trim()&&n.pop(),e)if(n.length>e)n.splice(e);else for(;n.length<e;)n.push("");for(;r<n.length;r++)n[r]=n[r].trim().replace(N.slashPipe,"|");return n}function ne(t,e,s){let n=t.length;if(n===0)return"";let r=0;for(;r<n&&t.charAt(n-r-1)===e;)r++;return t.slice(0,n-r)}function $t(t,e){if(t.indexOf(e[1])===-1)return-1;let s=0;for(let n=0;n<t.length;n++)if(t[n]==="\\")n++;else if(t[n]===e[0])s++;else if(t[n]===e[1]&&(s--,s<0))return n;return s>0?-2:-1}function Ue(t,e,s,n,r){let a=e.href,i=e.title||null,o=t[1].replace(r.other.outputLinkReplace,"$1");n.state.inLink=!0;let c={type:t[0].charAt(0)==="!"?"image":"link",raw:s,href:a,title:i,text:o,tokens:n.inlineTokens(o)};return n.state.inLink=!1,c}function Ut(t,e,s){let n=t.match(s.other.indentCodeCompensation);if(n===null)return e;let r=n[1];return e.split(`
`).map(a=>{let i=a.match(s.other.beginningSpace);if(i===null)return a;let[o]=i;return o.length>=r.length?a.slice(r.length):a}).join(`
`)}var pe=class{options;rules;lexer;constructor(t){this.options=t||te}space(t){let e=this.rules.block.newline.exec(t);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(t){let e=this.rules.block.code.exec(t);if(e){let s=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?s:ne(s,`
`)}}}fences(t){let e=this.rules.block.fences.exec(t);if(e){let s=e[0],n=Ut(s,e[3]||"",this.rules);return{type:"code",raw:s,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:n}}}heading(t){let e=this.rules.block.heading.exec(t);if(e){let s=e[2].trim();if(this.rules.other.endingHash.test(s)){let n=ne(s,"#");(this.options.pedantic||!n||this.rules.other.endingSpaceChar.test(n))&&(s=n.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:s,tokens:this.lexer.inline(s)}}}hr(t){let e=this.rules.block.hr.exec(t);if(e)return{type:"hr",raw:ne(e[0],`
`)}}blockquote(t){let e=this.rules.block.blockquote.exec(t);if(e){let s=ne(e[0],`
`).split(`
`),n="",r="",a=[];for(;s.length>0;){let i=!1,o=[],c;for(c=0;c<s.length;c++)if(this.rules.other.blockquoteStart.test(s[c]))o.push(s[c]),i=!0;else if(!i)o.push(s[c]);else break;s=s.slice(c);let h=o.join(`
`),d=h.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}
${h}`:h,r=r?`${r}
${d}`:d;let k=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(d,a,!0),this.lexer.state.top=k,s.length===0)break;let u=a.at(-1);if(u?.type==="code")break;if(u?.type==="blockquote"){let _=u,f=_.raw+`
`+s.join(`
`),p=this.blockquote(f);a[a.length-1]=p,n=n.substring(0,n.length-_.raw.length)+p.raw,r=r.substring(0,r.length-_.text.length)+p.text;break}else if(u?.type==="list"){let _=u,f=_.raw+`
`+s.join(`
`),p=this.list(f);a[a.length-1]=p,n=n.substring(0,n.length-u.raw.length)+p.raw,r=r.substring(0,r.length-_.raw.length)+p.raw,s=f.substring(a.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:n,tokens:a,text:r}}}list(t){let e=this.rules.block.list.exec(t);if(e){let s=e[1].trim(),n=s.length>1,r={type:"list",raw:"",ordered:n,start:n?+s.slice(0,-1):"",loose:!1,items:[]};s=n?`\\d{1,9}\\${s.slice(-1)}`:`\\${s}`,this.options.pedantic&&(s=n?s:"[*+-]");let a=this.rules.other.listItemRegex(s),i=!1;for(;t;){let c=!1,h="",d="";if(!(e=a.exec(t))||this.rules.block.hr.test(t))break;h=e[0],t=t.substring(h.length);let k=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,b=>" ".repeat(3*b.length)),u=t.split(`
`,1)[0],_=!k.trim(),f=0;if(this.options.pedantic?(f=2,d=k.trimStart()):_?f=e[1].length+1:(f=e[2].search(this.rules.other.nonSpaceChar),f=f>4?1:f,d=k.slice(f),f+=e[1].length),_&&this.rules.other.blankLine.test(u)&&(h+=u+`
`,t=t.substring(u.length+1),c=!0),!c){let b=this.rules.other.nextBulletRegex(f),E=this.rules.other.hrRegex(f),T=this.rules.other.fencesBeginRegex(f),A=this.rules.other.headingBeginRegex(f),w=this.rules.other.htmlBeginRegex(f);for(;t;){let C=t.split(`
`,1)[0],y;if(u=C,this.options.pedantic?(u=u.replace(this.rules.other.listReplaceNesting,"  "),y=u):y=u.replace(this.rules.other.tabCharGlobal,"    "),T.test(u)||A.test(u)||w.test(u)||b.test(u)||E.test(u))break;if(y.search(this.rules.other.nonSpaceChar)>=f||!u.trim())d+=`
`+y.slice(f);else{if(_||k.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||T.test(k)||A.test(k)||E.test(k))break;d+=`
`+u}!_&&!u.trim()&&(_=!0),h+=C+`
`,t=t.substring(C.length+1),k=y.slice(f)}}r.loose||(i?r.loose=!0:this.rules.other.doubleBlankLine.test(h)&&(i=!0));let p=null,g;this.options.gfm&&(p=this.rules.other.listIsTask.exec(d),p&&(g=p[0]!=="[ ] ",d=d.replace(this.rules.other.listReplaceTask,""))),r.items.push({type:"list_item",raw:h,task:!!p,checked:g,loose:!1,text:d,tokens:[]}),r.raw+=h}let o=r.items.at(-1);if(o)o.raw=o.raw.trimEnd(),o.text=o.text.trimEnd();else return;r.raw=r.raw.trimEnd();for(let c=0;c<r.items.length;c++)if(this.lexer.state.top=!1,r.items[c].tokens=this.lexer.blockTokens(r.items[c].text,[]),!r.loose){let h=r.items[c].tokens.filter(k=>k.type==="space"),d=h.length>0&&h.some(k=>this.rules.other.anyLine.test(k.raw));r.loose=d}if(r.loose)for(let c=0;c<r.items.length;c++)r.items[c].loose=!0;return r}}html(t){let e=this.rules.block.html.exec(t);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(t){let e=this.rules.block.def.exec(t);if(e){let s=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",r=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:s,raw:e[0],href:n,title:r}}}table(t){let e=this.rules.block.table.exec(t);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let s=$e(e[1]),n=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),r=e[3]?.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],a={type:"table",raw:e[0],header:[],align:[],rows:[]};if(s.length===n.length){for(let i of n)this.rules.other.tableAlignRight.test(i)?a.align.push("right"):this.rules.other.tableAlignCenter.test(i)?a.align.push("center"):this.rules.other.tableAlignLeft.test(i)?a.align.push("left"):a.align.push(null);for(let i=0;i<s.length;i++)a.header.push({text:s[i],tokens:this.lexer.inline(s[i]),header:!0,align:a.align[i]});for(let i of r)a.rows.push($e(i,a.header.length).map((o,c)=>({text:o,tokens:this.lexer.inline(o),header:!1,align:a.align[c]})));return a}}lheading(t){let e=this.rules.block.lheading.exec(t);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(t){let e=this.rules.block.paragraph.exec(t);if(e){let s=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:s,tokens:this.lexer.inline(s)}}}text(t){let e=this.rules.block.text.exec(t);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(t){let e=this.rules.inline.escape.exec(t);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(t){let e=this.rules.inline.tag.exec(t);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(t){let e=this.rules.inline.link.exec(t);if(e){let s=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(s)){if(!this.rules.other.endAngleBracket.test(s))return;let a=ne(s.slice(0,-1),"\\");if((s.length-a.length)%2===0)return}else{let a=$t(e[2],"()");if(a===-2)return;if(a>-1){let i=(e[0].indexOf("!")===0?5:4)+e[1].length+a;e[2]=e[2].substring(0,a),e[0]=e[0].substring(0,i).trim(),e[3]=""}}let n=e[2],r="";if(this.options.pedantic){let a=this.rules.other.pedanticHrefTitle.exec(n);a&&(n=a[1],r=a[3])}else r=e[3]?e[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(s)?n=n.slice(1):n=n.slice(1,-1)),Ue(e,{href:n&&n.replace(this.rules.inline.anyPunctuation,"$1"),title:r&&r.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(t,e){let s;if((s=this.rules.inline.reflink.exec(t))||(s=this.rules.inline.nolink.exec(t))){let n=(s[2]||s[1]).replace(this.rules.other.multipleSpaceGlobal," "),r=e[n.toLowerCase()];if(!r){let a=s[0].charAt(0);return{type:"text",raw:a,text:a}}return Ue(s,r,s[0],this.lexer,this.rules)}}emStrong(t,e,s=""){let n=this.rules.inline.emStrongLDelim.exec(t);if(!(!n||n[3]&&s.match(this.rules.other.unicodeAlphaNumeric))&&(!(n[1]||n[2])||!s||this.rules.inline.punctuation.exec(s))){let r=[...n[0]].length-1,a,i,o=r,c=0,h=n[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(h.lastIndex=0,e=e.slice(-1*t.length+r);(n=h.exec(e))!=null;){if(a=n[1]||n[2]||n[3]||n[4]||n[5]||n[6],!a)continue;if(i=[...a].length,n[3]||n[4]){o+=i;continue}else if((n[5]||n[6])&&r%3&&!((r+i)%3)){c+=i;continue}if(o-=i,o>0)continue;i=Math.min(i,i+o+c);let d=[...n[0]][0].length,k=t.slice(0,r+n.index+d+i);if(Math.min(r,i)%2){let _=k.slice(1,-1);return{type:"em",raw:k,text:_,tokens:this.lexer.inlineTokens(_)}}let u=k.slice(2,-2);return{type:"strong",raw:k,text:u,tokens:this.lexer.inlineTokens(u)}}}}codespan(t){let e=this.rules.inline.code.exec(t);if(e){let s=e[2].replace(this.rules.other.newLineCharGlobal," "),n=this.rules.other.nonSpaceChar.test(s),r=this.rules.other.startingSpaceChar.test(s)&&this.rules.other.endingSpaceChar.test(s);return n&&r&&(s=s.substring(1,s.length-1)),{type:"codespan",raw:e[0],text:s}}}br(t){let e=this.rules.inline.br.exec(t);if(e)return{type:"br",raw:e[0]}}del(t){let e=this.rules.inline.del.exec(t);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(t){let e=this.rules.inline.autolink.exec(t);if(e){let s,n;return e[2]==="@"?(s=e[1],n="mailto:"+s):(s=e[1],n=s),{type:"link",raw:e[0],text:s,href:n,tokens:[{type:"text",raw:s,text:s}]}}}url(t){let e;if(e=this.rules.inline.url.exec(t)){let s,n;if(e[2]==="@")s=e[0],n="mailto:"+s;else{let r;do r=e[0],e[0]=this.rules.inline._backpedal.exec(e[0])?.[0]??"";while(r!==e[0]);s=e[0],e[1]==="www."?n="http://"+e[0]:n=e[0]}return{type:"link",raw:e[0],text:s,href:n,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(t){let e=this.rules.inline.text.exec(t);if(e){let s=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:s}}}},W=class be{tokens;options;state;tokenizer;inlineQueue;constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||te,this.options.tokenizer=this.options.tokenizer||new pe,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let s={other:N,block:ce.normal,inline:se.normal};this.options.pedantic?(s.block=ce.pedantic,s.inline=se.pedantic):this.options.gfm&&(s.block=ce.gfm,this.options.breaks?s.inline=se.breaks:s.inline=se.gfm),this.tokenizer.rules=s}static get rules(){return{block:ce,inline:se}}static lex(e,s){return new be(s).lex(e)}static lexInline(e,s){return new be(s).inlineTokens(e)}lex(e){e=e.replace(N.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let s=0;s<this.inlineQueue.length;s++){let n=this.inlineQueue[s];this.inlineTokens(n.src,n.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,s=[],n=!1){for(this.options.pedantic&&(e=e.replace(N.tabCharGlobal,"    ").replace(N.spaceLine,""));e;){let r;if(this.options.extensions?.block?.some(i=>(r=i.call({lexer:this},e,s))?(e=e.substring(r.raw.length),s.push(r),!0):!1))continue;if(r=this.tokenizer.space(e)){e=e.substring(r.raw.length);let i=s.at(-1);r.raw.length===1&&i!==void 0?i.raw+=`
`:s.push(r);continue}if(r=this.tokenizer.code(e)){e=e.substring(r.raw.length);let i=s.at(-1);i?.type==="paragraph"||i?.type==="text"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+r.raw,i.text+=`
`+r.text,this.inlineQueue.at(-1).src=i.text):s.push(r);continue}if(r=this.tokenizer.fences(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.heading(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.hr(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.blockquote(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.list(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.html(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.def(e)){e=e.substring(r.raw.length);let i=s.at(-1);i?.type==="paragraph"||i?.type==="text"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+r.raw,i.text+=`
`+r.raw,this.inlineQueue.at(-1).src=i.text):this.tokens.links[r.tag]||(this.tokens.links[r.tag]={href:r.href,title:r.title},s.push(r));continue}if(r=this.tokenizer.table(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.lheading(e)){e=e.substring(r.raw.length),s.push(r);continue}let a=e;if(this.options.extensions?.startBlock){let i=1/0,o=e.slice(1),c;this.options.extensions.startBlock.forEach(h=>{c=h.call({lexer:this},o),typeof c=="number"&&c>=0&&(i=Math.min(i,c))}),i<1/0&&i>=0&&(a=e.substring(0,i+1))}if(this.state.top&&(r=this.tokenizer.paragraph(a))){let i=s.at(-1);n&&i?.type==="paragraph"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+r.raw,i.text+=`
`+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=i.text):s.push(r),n=a.length!==e.length,e=e.substring(r.raw.length);continue}if(r=this.tokenizer.text(e)){e=e.substring(r.raw.length);let i=s.at(-1);i?.type==="text"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+r.raw,i.text+=`
`+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=i.text):s.push(r);continue}if(e){let i="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(i);break}else throw new Error(i)}}return this.state.top=!0,s}inline(e,s=[]){return this.inlineQueue.push({src:e,tokens:s}),s}inlineTokens(e,s=[]){let n=e,r=null;if(this.tokens.links){let o=Object.keys(this.tokens.links);if(o.length>0)for(;(r=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)o.includes(r[0].slice(r[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(r=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,r.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;(r=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let a=!1,i="";for(;e;){a||(i=""),a=!1;let o;if(this.options.extensions?.inline?.some(h=>(o=h.call({lexer:this},e,s))?(e=e.substring(o.raw.length),s.push(o),!0):!1))continue;if(o=this.tokenizer.escape(e)){e=e.substring(o.raw.length),s.push(o);continue}if(o=this.tokenizer.tag(e)){e=e.substring(o.raw.length),s.push(o);continue}if(o=this.tokenizer.link(e)){e=e.substring(o.raw.length),s.push(o);continue}if(o=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(o.raw.length);let h=s.at(-1);o.type==="text"&&h?.type==="text"?(h.raw+=o.raw,h.text+=o.text):s.push(o);continue}if(o=this.tokenizer.emStrong(e,n,i)){e=e.substring(o.raw.length),s.push(o);continue}if(o=this.tokenizer.codespan(e)){e=e.substring(o.raw.length),s.push(o);continue}if(o=this.tokenizer.br(e)){e=e.substring(o.raw.length),s.push(o);continue}if(o=this.tokenizer.del(e)){e=e.substring(o.raw.length),s.push(o);continue}if(o=this.tokenizer.autolink(e)){e=e.substring(o.raw.length),s.push(o);continue}if(!this.state.inLink&&(o=this.tokenizer.url(e))){e=e.substring(o.raw.length),s.push(o);continue}let c=e;if(this.options.extensions?.startInline){let h=1/0,d=e.slice(1),k;this.options.extensions.startInline.forEach(u=>{k=u.call({lexer:this},d),typeof k=="number"&&k>=0&&(h=Math.min(h,k))}),h<1/0&&h>=0&&(c=e.substring(0,h+1))}if(o=this.tokenizer.inlineText(c)){e=e.substring(o.raw.length),o.raw.slice(-1)!=="_"&&(i=o.raw.slice(-1)),a=!0;let h=s.at(-1);h?.type==="text"?(h.raw+=o.raw,h.text+=o.text):s.push(o);continue}if(e){let h="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(h);break}else throw new Error(h)}}return s}},ge=class{options;parser;constructor(t){this.options=t||te}space(t){return""}code({text:t,lang:e,escaped:s}){let n=(e||"").match(N.notSpaceStart)?.[0],r=t.replace(N.endingNewline,"")+`
`;return n?'<pre><code class="language-'+Y(n)+'">'+(s?r:Y(r,!0))+`</code></pre>
`:"<pre><code>"+(s?r:Y(r,!0))+`</code></pre>
`}blockquote({tokens:t}){return`<blockquote>
${this.parser.parse(t)}</blockquote>
`}html({text:t}){return t}def(t){return""}heading({tokens:t,depth:e}){return`<h${e}>${this.parser.parseInline(t)}</h${e}>
`}hr(t){return`<hr>
`}list(t){let e=t.ordered,s=t.start,n="";for(let i=0;i<t.items.length;i++){let o=t.items[i];n+=this.listitem(o)}let r=e?"ol":"ul",a=e&&s!==1?' start="'+s+'"':"";return"<"+r+a+`>
`+n+"</"+r+`>
`}listitem(t){let e="";if(t.task){let s=this.checkbox({checked:!!t.checked});t.loose?t.tokens[0]?.type==="paragraph"?(t.tokens[0].text=s+" "+t.tokens[0].text,t.tokens[0].tokens&&t.tokens[0].tokens.length>0&&t.tokens[0].tokens[0].type==="text"&&(t.tokens[0].tokens[0].text=s+" "+Y(t.tokens[0].tokens[0].text),t.tokens[0].tokens[0].escaped=!0)):t.tokens.unshift({type:"text",raw:s+" ",text:s+" ",escaped:!0}):e+=s+" "}return e+=this.parser.parse(t.tokens,!!t.loose),`<li>${e}</li>
`}checkbox({checked:t}){return"<input "+(t?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:t}){return`<p>${this.parser.parseInline(t)}</p>
`}table(t){let e="",s="";for(let r=0;r<t.header.length;r++)s+=this.tablecell(t.header[r]);e+=this.tablerow({text:s});let n="";for(let r=0;r<t.rows.length;r++){let a=t.rows[r];s="";for(let i=0;i<a.length;i++)s+=this.tablecell(a[i]);n+=this.tablerow({text:s})}return n&&(n=`<tbody>${n}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+n+`</table>
`}tablerow({text:t}){return`<tr>
${t}</tr>
`}tablecell(t){let e=this.parser.parseInline(t.tokens),s=t.header?"th":"td";return(t.align?`<${s} align="${t.align}">`:`<${s}>`)+e+`</${s}>
`}strong({tokens:t}){return`<strong>${this.parser.parseInline(t)}</strong>`}em({tokens:t}){return`<em>${this.parser.parseInline(t)}</em>`}codespan({text:t}){return`<code>${Y(t,!0)}</code>`}br(t){return"<br>"}del({tokens:t}){return`<del>${this.parser.parseInline(t)}</del>`}link({href:t,title:e,tokens:s}){let n=this.parser.parseInline(s),r=Pe(t);if(r===null)return n;t=r;let a='<a href="'+t+'"';return e&&(a+=' title="'+Y(e)+'"'),a+=">"+n+"</a>",a}image({href:t,title:e,text:s,tokens:n}){n&&(s=this.parser.parseInline(n,this.parser.textRenderer));let r=Pe(t);if(r===null)return Y(s);t=r;let a=`<img src="${t}" alt="${s}"`;return e&&(a+=` title="${Y(e)}"`),a+=">",a}text(t){return"tokens"in t&&t.tokens?this.parser.parseInline(t.tokens):"escaped"in t&&t.escaped?t.text:Y(t.text)}},Le=class{strong({text:t}){return t}em({text:t}){return t}codespan({text:t}){return t}del({text:t}){return t}html({text:t}){return t}text({text:t}){return t}link({text:t}){return""+t}image({text:t}){return""+t}br(){return""}},j=class ke{options;renderer;textRenderer;constructor(e){this.options=e||te,this.options.renderer=this.options.renderer||new ge,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Le}static parse(e,s){return new ke(s).parse(e)}static parseInline(e,s){return new ke(s).parseInline(e)}parse(e,s=!0){let n="";for(let r=0;r<e.length;r++){let a=e[r];if(this.options.extensions?.renderers?.[a.type]){let o=a,c=this.options.extensions.renderers[o.type].call({parser:this},o);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(o.type)){n+=c||"";continue}}let i=a;switch(i.type){case"space":{n+=this.renderer.space(i);continue}case"hr":{n+=this.renderer.hr(i);continue}case"heading":{n+=this.renderer.heading(i);continue}case"code":{n+=this.renderer.code(i);continue}case"table":{n+=this.renderer.table(i);continue}case"blockquote":{n+=this.renderer.blockquote(i);continue}case"list":{n+=this.renderer.list(i);continue}case"html":{n+=this.renderer.html(i);continue}case"def":{n+=this.renderer.def(i);continue}case"paragraph":{n+=this.renderer.paragraph(i);continue}case"text":{let o=i,c=this.renderer.text(o);for(;r+1<e.length&&e[r+1].type==="text";)o=e[++r],c+=`
`+this.renderer.text(o);s?n+=this.renderer.paragraph({type:"paragraph",raw:c,text:c,tokens:[{type:"text",raw:c,text:c,escaped:!0}]}):n+=c;continue}default:{let o='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(o),"";throw new Error(o)}}}return n}parseInline(e,s=this.renderer){let n="";for(let r=0;r<e.length;r++){let a=e[r];if(this.options.extensions?.renderers?.[a.type]){let o=this.options.extensions.renderers[a.type].call({parser:this},a);if(o!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(a.type)){n+=o||"";continue}}let i=a;switch(i.type){case"escape":{n+=s.text(i);break}case"html":{n+=s.html(i);break}case"link":{n+=s.link(i);break}case"image":{n+=s.image(i);break}case"strong":{n+=s.strong(i);break}case"em":{n+=s.em(i);break}case"codespan":{n+=s.codespan(i);break}case"br":{n+=s.br(i);break}case"del":{n+=s.del(i);break}case"text":{n+=s.text(i);break}default:{let o='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(o),"";throw new Error(o)}}}return n}},ue=class{options;block;constructor(t){this.options=t||te}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(t){return t}postprocess(t){return t}processAllTokens(t){return t}provideLexer(){return this.block?W.lex:W.lexInline}provideParser(){return this.block?j.parse:j.parseInline}},Ot=class{defaults=Se();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=j;Renderer=ge;TextRenderer=Le;Lexer=W;Tokenizer=pe;Hooks=ue;constructor(...t){this.use(...t)}walkTokens(t,e){let s=[];for(let n of t)switch(s=s.concat(e.call(this,n)),n.type){case"table":{let r=n;for(let a of r.header)s=s.concat(this.walkTokens(a.tokens,e));for(let a of r.rows)for(let i of a)s=s.concat(this.walkTokens(i.tokens,e));break}case"list":{let r=n;s=s.concat(this.walkTokens(r.items,e));break}default:{let r=n;this.defaults.extensions?.childTokens?.[r.type]?this.defaults.extensions.childTokens[r.type].forEach(a=>{let i=r[a].flat(1/0);s=s.concat(this.walkTokens(i,e))}):r.tokens&&(s=s.concat(this.walkTokens(r.tokens,e)))}}return s}use(...t){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return t.forEach(s=>{let n={...s};if(n.async=this.defaults.async||n.async||!1,s.extensions&&(s.extensions.forEach(r=>{if(!r.name)throw new Error("extension name required");if("renderer"in r){let a=e.renderers[r.name];a?e.renderers[r.name]=function(...i){let o=r.renderer.apply(this,i);return o===!1&&(o=a.apply(this,i)),o}:e.renderers[r.name]=r.renderer}if("tokenizer"in r){if(!r.level||r.level!=="block"&&r.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let a=e[r.level];a?a.unshift(r.tokenizer):e[r.level]=[r.tokenizer],r.start&&(r.level==="block"?e.startBlock?e.startBlock.push(r.start):e.startBlock=[r.start]:r.level==="inline"&&(e.startInline?e.startInline.push(r.start):e.startInline=[r.start]))}"childTokens"in r&&r.childTokens&&(e.childTokens[r.name]=r.childTokens)}),n.extensions=e),s.renderer){let r=this.defaults.renderer||new ge(this.defaults);for(let a in s.renderer){if(!(a in r))throw new Error(`renderer '${a}' does not exist`);if(["options","parser"].includes(a))continue;let i=a,o=s.renderer[i],c=r[i];r[i]=(...h)=>{let d=o.apply(r,h);return d===!1&&(d=c.apply(r,h)),d||""}}n.renderer=r}if(s.tokenizer){let r=this.defaults.tokenizer||new pe(this.defaults);for(let a in s.tokenizer){if(!(a in r))throw new Error(`tokenizer '${a}' does not exist`);if(["options","rules","lexer"].includes(a))continue;let i=a,o=s.tokenizer[i],c=r[i];r[i]=(...h)=>{let d=o.apply(r,h);return d===!1&&(d=c.apply(r,h)),d}}n.tokenizer=r}if(s.hooks){let r=this.defaults.hooks||new ue;for(let a in s.hooks){if(!(a in r))throw new Error(`hook '${a}' does not exist`);if(["options","block"].includes(a))continue;let i=a,o=s.hooks[i],c=r[i];ue.passThroughHooks.has(a)?r[i]=h=>{if(this.defaults.async)return Promise.resolve(o.call(r,h)).then(k=>c.call(r,k));let d=o.call(r,h);return c.call(r,d)}:r[i]=(...h)=>{let d=o.apply(r,h);return d===!1&&(d=c.apply(r,h)),d}}n.hooks=r}if(s.walkTokens){let r=this.defaults.walkTokens,a=s.walkTokens;n.walkTokens=function(i){let o=[];return o.push(a.call(this,i)),r&&(o=o.concat(r.call(this,i))),o}}this.defaults={...this.defaults,...n}}),this}setOptions(t){return this.defaults={...this.defaults,...t},this}lexer(t,e){return W.lex(t,e??this.defaults)}parser(t,e){return j.parse(t,e??this.defaults)}parseMarkdown(t){return(e,s)=>{let n={...s},r={...this.defaults,...n},a=this.onError(!!r.silent,!!r.async);if(this.defaults.async===!0&&n.async===!1)return a(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return a(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return a(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));r.hooks&&(r.hooks.options=r,r.hooks.block=t);let i=r.hooks?r.hooks.provideLexer():t?W.lex:W.lexInline,o=r.hooks?r.hooks.provideParser():t?j.parse:j.parseInline;if(r.async)return Promise.resolve(r.hooks?r.hooks.preprocess(e):e).then(c=>i(c,r)).then(c=>r.hooks?r.hooks.processAllTokens(c):c).then(c=>r.walkTokens?Promise.all(this.walkTokens(c,r.walkTokens)).then(()=>c):c).then(c=>o(c,r)).then(c=>r.hooks?r.hooks.postprocess(c):c).catch(a);try{r.hooks&&(e=r.hooks.preprocess(e));let c=i(e,r);r.hooks&&(c=r.hooks.processAllTokens(c)),r.walkTokens&&this.walkTokens(c,r.walkTokens);let h=o(c,r);return r.hooks&&(h=r.hooks.postprocess(h)),h}catch(c){return a(c)}}}onError(t,e){return s=>{if(s.message+=`
Please report this to https://github.com/markedjs/marked.`,t){let n="<p>An error occurred:</p><pre>"+Y(s.message+"",!0)+"</pre>";return e?Promise.resolve(n):n}if(e)return Promise.reject(s);throw s}}},ee=new Ot;function I(t,e){return ee.parse(t,e)}I.options=I.setOptions=function(t){return ee.setOptions(t),I.defaults=ee.defaults,Ne(I.defaults),I};I.getDefaults=Se;I.defaults=te;I.use=function(...t){return ee.use(...t),I.defaults=ee.defaults,Ne(I.defaults),I};I.walkTokens=function(t,e){return ee.walkTokens(t,e)};I.parseInline=ee.parseInline;I.Parser=j;I.parser=j.parse;I.Renderer=ge;I.TextRenderer=Le;I.Lexer=W;I.lexer=W.lex;I.Tokenizer=pe;I.Hooks=ue;I.parse=I;I.options;I.setOptions;I.use;I.walkTokens;I.parseInline;j.parse;W.lex;var P=function(){this.callback=null,this.hex=null,this.verify_hex=[],this.usbDevice=null,this.request={DETACH:0,DNLOAD:1,UPLOAD:2,GETSTATUS:3,CLRSTATUS:4,GETSTATE:5,ABORT:6},this.status={OK:0,errTARGET:1,errFILE:2,errWRITE:3,errERASE:4,errCHECK_ERASED:5,errPROG:6,errVERIFY:7,errADDRESS:8,errNOTDONE:9,errFIRMWARE:10,errVENDOR:11,errUSBR:12,errPOR:13,errUNKNOWN:14,errSTALLEDPKT:15},this.state={appIDLE:0,appDETACH:1,dfuIDLE:2,dfuDNLOAD_SYNC:3,dfuDNBUSY:4,dfuDNLOAD_IDLE:5,dfuMANIFEST_SYNC:6,dfuMANIFEST:7,dfuMANIFEST_WAIT_RESET:8,dfuUPLOAD_IDLE:9,dfuERROR:10},this.chipInfo=null,this.flash_layout={start_address:0,total_size:0,sectors:[]},this.transferSize=2048};P.prototype.connect=function(t,e,s,n){var r=this;r.hex=e,r.callback=n,r.options={erase_chip:!1,exitDfu:!1},s.exitDfu?r.options.exitDfu=!0:s.erase_chip&&(r.options.erase_chip=!0),r.upload_time_start=new Date().getTime(),r.verify_hex=[],v.firmware_flasher.flashingMessage(null,v.firmware_flasher.FLASH_MESSAGE_TYPES.NEUTRAL).flashProgress(0),navigator.usb.getDevices().then(a=>{a.forEach(i=>{t.forEach(o=>{if(i.vendorId==o.vendorId&&i.productId==o.productId){r.usbDevice=i;return}})}),r.usbDevice?(console.log("USB DFU detected"),r.openDevice()):(console.log("USB DFU not found"),m.log(x.getMessage("stm32UsbDfuNotFound")))})};P.prototype.openDevice=function(){var t=this;t.usbDevice.open().then(()=>{m.log(x.getMessage("usbDeviceOpened")),console.log("USB-Device opened"),t.claimInterface(0)}).catch(e=>{console.log("Failed to open USB device: "+e),m.log(x.getMessage("usbDeviceOpenFail")),m.operating_system==="Linux"&&m.log(x.getMessage("usbDeviceUdevNotice"))})};P.prototype.closeDevice=function(){var t=this;t.usbDevice.close().then(()=>{m.log(x.getMessage("usbDeviceClosed")),console.log("USB-Device closed")}).catch(e=>{console.log("Failed to close USB device!"),m.log(x.getMessage("usbDeviceCloseFail"))}),t.usbDevice=null};P.prototype.claimInterface=function(t){var e=this;e.usbDevice.claimInterface(t).then(()=>{console.log("Claimed interface: "+t),e.options.exitDfu?e.leave():e.upload_procedure(0)}).catch(s=>{console.log("Failed to claim USB device: "+s),e.cleanup()})};P.prototype.releaseInterface=function(t){var e=this;e.usbDevice.releaseInterface(t).then(()=>{console.log("Released interface: "+t),e.closeDevice()})};P.prototype.resetDevice=function(t){var e=this;e.usbDevice.reset().then(()=>{console.log("Reset USB-Device"),t&&t()})};P.prototype.getString=function(t,e){var s=this,n={recipient:"device",requestType:"standard",request:6,value:768|t,index:0};s.usbDevice.controlTransferIn(n,255).then(r=>{if(r.status=="ok"){for(var a=r.data.getUint8(0),i="",o=2;o<a;o+=2){var c=r.data.getUint16(o,!0);i+=String.fromCharCode(c)}e(i,0)}else throw new Error(r.status)}).catch(r=>{console.log("USB getString failed: "+r),e("",1)})};P.prototype.getInterfaceDescriptors=function(t,e){var s=this,n=0,r=[],a=s.usbDevice.configuration.interfaces.length,i=0;a==0?e(0,1):a==1?i=s.usbDevice.configuration.interfaces[0].alternates.length:a>1&&(i=a);var o=function(){if(n<i)s.getInterfaceDescriptor(n,function(c,h){if(h){e([],h);return}n++,s.getString(c.iInterface,function(d,k){if(k){e([],k);return}c.bInterfaceNumber==t&&r.push(d),o()})});else{e(r,0);return}};o()};P.prototype.getInterfaceDescriptor=function(t,e){var s=this,n={recipient:"device",requestType:"standard",request:6,value:512,index:0};s.usbDevice.controlTransferIn(n,18+t*9).then(r=>{if(r.status=="ok"){var a=new Uint8Array(r.data.buffer,9+t*9),i={bLength:a[0],bDescriptorType:a[1],bInterfaceNumber:a[2],bAlternateSetting:a[3],bNumEndpoints:a[4],bInterfaceClass:a[5],bInterfaceSubclass:a[6],bInterfaceProtocol:a[7],iInterface:a[8]};e(i,0)}else throw new Error(r.status)}).catch(r=>{console.log("USB getInterfaceDescriptor failed: "+r),e({},1)})};P.prototype.getFunctionalDescriptor=function(t,e){var s=this,n={recipient:"interface",requestType:"standard",request:6,value:8448,index:0};s.usbDevice.controlTransferIn(n,255).then(r=>{if(r.status=="ok"){var a=new Uint8Array(r.data.buffer),i={bLength:a[0],bDescriptorType:a[1],bmAttributes:a[2],wDetachTimeOut:a[4]<<8|a[3],wTransferSize:a[6]<<8|a[5],bcdDFUVersion:a[7]};e(i,0)}else throw new Error(r.status)}).catch(r=>{console.log("USB getFunctionalDescriptor failed! "+r),e({},1)})};P.prototype.getChipInfo=function(t,e){var s=this;s.getInterfaceDescriptors(0,function(n,r){if(r){e({},r);return}var a=function(o){o=="@External Flash /0x90000000/1001*128Kg,3*128Kg,20*128Ka"&&(o="@External Flash /0x90000000/998*128Kg,1*128Kg,4*128Kg,21*128Ka");var c=o.replace(/[^\x20-\x7E]+/g,""),h=c.split("/");if(h.length>3&&(console.log('parseDescriptor: shrinking long descriptor "'+o+'"'),h.length=3),!h[0].startsWith("@"))return null;var d=h[0].trim().replace("@",""),k=parseInt(h[1]),u=[],_=0,f=h[2].split(",");if(f.length<1)return null;for(var p=0;p<f.length;p++){var g=f[p].split("*");if(g.length!=2)return null;var b=parseInt(g[0]),E=parseInt(g[1]);if(!E)return null;var T=g[1].slice(-2,-1);switch(T){case"M":E*=1024;case"K":E*=1024;break}u.push({num_pages:b,start_address:k+_,page_size:E,total_size:b*E}),_+=b*E}var A={type:d,start_address:k,sectors:u,total_size:_};return A},i=n.map(a).reduce(function(o,c,h){return o[c.type.toLowerCase().replace(" ","_")]=c,o},{});e(i,r)})};P.prototype.controlTransfer=function(t,e,s,n,r,a,i,o){var c=this;if(t=="in"){var h={recipient:"interface",requestType:"class",request:e,value:s,index:n};c.usbDevice.controlTransferIn(h,r).then(k=>{if(k.status=="ok"){var u=new Uint8Array(k.data.buffer);i(u,k.resultCode)}else throw new Error(k.status)}).catch(()=>{console.log("USB controlTransfer IN failed for request "+e+"!")})}else{var d;a?d=new Uint8Array(a):d=new Uint8Array(0);var h={recipient:"interface",requestType:"class",request:e,value:s,index:n};c.usbDevice.controlTransferOut(h,d).then(u=>{if(u.status=="ok")i(u);else throw new Error(u.status)}).catch(()=>{console.log("USB controlTransfer OUT failed for request "+e+"!")})}};P.prototype.clearStatus=function(t){var e=this;function s(){e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(r){if(r[4]==e.state.dfuIDLE)t(r);else{var a=r[1]|r[2]<<8|r[3]<<16;setTimeout(n,a)}})}function n(){e.controlTransfer("out",e.request.CLRSTATUS,0,0,0,0,s)}s()};P.prototype.loadAddress=function(t,e,s){var n=this;n.controlTransfer("out",n.request.DNLOAD,0,0,0,[33,t&255,t>>8&255,t>>16&255,t>>24&255],function(){n.controlTransfer("in",n.request.GETSTATUS,0,0,6,0,function(r){if(r[4]==n.state.dfuDNBUSY){var a=r[1]|r[2]<<8|r[3]<<16;setTimeout(function(){n.controlTransfer("in",n.request.GETSTATUS,0,0,6,0,function(i){i[4]==n.state.dfuDNLOAD_IDLE?e(i):(console.log("Failed to execute address load"),typeof s>"u"||s?n.cleanup():e(i))})},a)}else console.log("Failed to request address load"),n.cleanup()})})};P.prototype.verify_flash=function(t,e){for(var s=0;s<t.length;s++)if(t[s]!=e[s])return console.log("Verification failed on byte: "+s+" expected: 0x"+t[s].toString(16)+" received: 0x"+e[s].toString(16)),!1;return console.log("Verification successful, matching: "+t.length+" bytes"),!0};P.prototype.upload_procedure=function(t){var e=this;switch(t){case 0:e.getChipInfo(0,function(S,z){if(z!=0||typeof S>"u")console.log("Failed to detect chip info, resultCode: "+z),e.cleanup();else if(typeof S.internal_flash<"u")e.chipInfo=S,e.flash_layout=S.internal_flash,e.available_flash_size=e.flash_layout.total_size-(e.hex.start_linear_address-e.flash_layout.start_address),m.log(x.getMessage("dfu_device_flash_info",(e.flash_layout.total_size/1024).toString())),e.hex.bytes_total>e.available_flash_size?(m.log(x.getMessage("dfu_error_image_size",[(e.hex.bytes_total/1024).toFixed(1),(e.available_flash_size/1024).toFixed(1)])),e.cleanup()):e.getFunctionalDescriptor(0,function(G,re){e.transferSize=re?2048:G.wTransferSize,console.log("Using transfer size: "+e.transferSize),e.clearStatus(function(){e.upload_procedure(1)})});else if(typeof S.external_flash<"u"){e.chipInfo=S,e.flash_layout=S.external_flash;var M=2,V=e.flash_layout.sectors[M],K=V.total_size;e.available_flash_size=K,m.log(x.getMessage("dfu_device_flash_info",(e.flash_layout.total_size/1024).toString())),e.hex.bytes_total>e.available_flash_size?(m.log(x.getMessage("dfu_error_image_size",[(e.hex.bytes_total/1024).toFixed(1),(e.available_flash_size/1024).toFixed(1)])),e.cleanup()):e.getFunctionalDescriptor(0,function(G,re){e.transferSize=re?2048:G.wTransferSize,console.log("Using transfer size: "+e.transferSize),e.clearStatus(function(){e.upload_procedure(2)})})}else console.log("Failed to detect internal or external flash"),e.cleanup()});break;case 1:typeof e.chipInfo.option_bytes>"u"&&typeof e.chipInfo.option_byte<"u"&&(e.chipInfo.option_bytes=e.chipInfo.option_byte),typeof e.chipInfo.option_bytes>"u"&&(console.log("Failed to detect option bytes"),e.cleanup());var s=function(){console.log("Initiate read unprotect");let S=x.getMessage("stm32ReadProtected");m.log(S),v.firmware_flasher.flashingMessage(S,v.firmware_flasher.FLASH_MESSAGE_TYPES.ACTION),e.controlTransfer("out",e.request.DNLOAD,0,0,0,[146],function(){e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(z){if(z[4]==e.state.dfuDNBUSY)var M=z[1]|z[2]<<8|z[3]<<16,V=M+2e4,K=0,G=1e3,re=setInterval(function(){if(v.firmware_flasher.flashProgress(Math.min(K/V,1)*100),K<V){K+=G;return}clearInterval(re),e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(le,Xe){if(Xe){console.log("Unprotect memory command ran successfully. Unplug flight controller. Connect again in DFU mode and try flashing again."),m.log(x.getMessage("stm32UnprotectSuccessful"));let Ie=x.getMessage("stm32UnprotectUnplug");m.log(Ie),v.firmware_flasher.flashingMessage(Ie,v.firmware_flasher.FLASH_MESSAGE_TYPES.ACTION).flashProgress(0)}else console.log("Failed to execute unprotect memory command"),m.log(x.getMessage("stm32UnprotectFailed")),v.firmware_flasher.flashingMessage(x.getMessage("stm32UnprotectFailed"),v.firmware_flasher.FLASH_MESSAGE_TYPES.INVALID),console.log(le),e.cleanup()},2e3)},G);else{console.log("Failed to initiate unprotect memory command");let le=x.getMessage("stm32UnprotectInitFailed");m.log(le),v.firmware_flasher.flashingMessage(le,v.firmware_flasher.FLASH_MESSAGE_TYPES.INVALID),e.cleanup()}})})},n=function(){e.controlTransfer("in",e.request.UPLOAD,2,0,e.chipInfo.option_bytes.total_size,0,function(S,z){if(z){console.log("USB transfer error while reading option bytes: "+errcode1),e.cleanup();return}e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(M){M[4]==e.state.dfuUPLOAD_IDLE&&S.length==e.chipInfo.option_bytes.total_size?(console.log("Option bytes read successfully"),console.log("Chip does not appear read protected"),m.log(x.getMessage("stm32NotReadProtected")),e.clearStatus(function(){e.upload_procedure(2)})):(console.log("Option bytes could not be read. Quite possibly read protected."),e.clearStatus(s))})})},r=function(S){if(S[4]==e.state.dfuERROR&&S[0]==e.status.errVENDOR){m.log(x.getMessage("stm32AddressLoadFailed")),e.clearStatus(s);return}else S[4]==e.state.dfuDNLOAD_IDLE?(console.log("Address load for option bytes sector succeeded."),e.clearStatus(n)):(m.log(x.getMessage("stm32AddressLoadUnknown")),e.cleanup())};e.clearStatus(function(){e.loadAddress(e.chipInfo.option_bytes.start_address,r,!1)});break;case 2:for(var a=[],i=0;i<e.flash_layout.sectors.length;i++)for(var o=0;o<e.flash_layout.sectors[i].num_pages;o++)if(e.options.erase_chip)a.push({sector:i,page:o});else for(var c=e.flash_layout.sectors[i].start_address+o*e.flash_layout.sectors[i].page_size,h=c+e.flash_layout.sectors[i].page_size-1,d=0;d<e.hex.data.length;d++){var k=e.hex.data[d].address>=c&&e.hex.data[d].address<=h,u=e.hex.data[d].address+e.hex.data[d].bytes-1,_=u>=c&&u<=h,f=e.hex.data[d].address<c&&u>h;if(k||_||f){var p=a.findIndex(function(S,z,M){return S.sector==i&&S.page==o});p==-1&&a.push({sector:i,page:o})}}if(a.length===0){console.log("Aborting, No flash pages to erase"),v.firmware_flasher.flashingMessage(x.getMessage("stm32InvalidHex"),v.firmware_flasher.FLASH_MESSAGE_TYPES.INVALID),e.cleanup();break}v.firmware_flasher.flashingMessage(x.getMessage("stm32Erase"),v.firmware_flasher.FLASH_MESSAGE_TYPES.NEUTRAL),console.log("Executing local chip erase",a);var g=0,b=0,E=function(){v.firmware_flasher.flashProgress((g+1)/a.length*100),g++,g==a.length?(console.log("Erase: complete"),m.log(x.getMessage("dfu_erased_kilobytes",(b/1024).toString())),e.upload_procedure(4)):T()},T=function(){var S=a[g].page*e.flash_layout.sectors[a[g].sector].page_size+e.flash_layout.sectors[a[g].sector].start_address,z=[65,S&255,S>>8&255,S>>16&255,S>>24&255];b+=e.flash_layout.sectors[a[g].sector].page_size,console.log("Erasing. sector "+a[g].sector+", page "+a[g].page+" @ 0x"+S.toString(16)),e.controlTransfer("out",e.request.DNLOAD,0,0,0,z,function(){e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(M){if(M[4]==e.state.dfuDNBUSY){var V=M[1]|M[2]<<8|M[3]<<16;setTimeout(function(){e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(K){K[4]==e.state.dfuDNBUSY?(console.log("erase_page: dfuDNBUSY after timeout, clearing"),e.clearStatus(function(){e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(G){G[4]==e.state.dfuIDLE?E():(console.log("Failed to erase page 0x"+S.toString(16)+" (did not reach dfuIDLE after clearing"),e.cleanup())})})):K[4]==e.state.dfuDNLOAD_IDLE?E():(console.log("Failed to erase page 0x"+S.toString(16)),e.cleanup())})},V)}else console.log("Failed to initiate page erase, page 0x"+S.toString(16)),e.cleanup()})})};T();break;case 4:console.log("Writing data ..."),v.firmware_flasher.flashingMessage(x.getMessage("stm32Flashing"),v.firmware_flasher.FLASH_MESSAGE_TYPES.NEUTRAL);var F=e.hex.data.length-1,A=0,R=e.hex.data[A].address,w=0,C=0,B=2,y=function(){if(w<e.hex.data[A].bytes){var S=w+e.transferSize<=e.hex.data[A].bytes?e.transferSize:e.hex.data[A].bytes-w,z=e.hex.data[A].data.slice(w,w+S);R+=S,w+=S,C+=S,e.controlTransfer("out",e.request.DNLOAD,B++,0,0,z,function(){e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(M){if(M[4]==e.state.dfuDNBUSY){var V=M[1]|M[2]<<8|M[3]<<16;setTimeout(function(){e.controlTransfer("in",e.request.GETSTATUS,0,0,6,0,function(K){K[4]==e.state.dfuDNLOAD_IDLE?(v.firmware_flasher.flashProgress(C/(e.hex.bytes_total*2)*100),y()):(console.log("Failed to write "+S+"bytes to 0x"+R.toString(16)),e.cleanup())})},V)}else console.log("Failed to initiate write "+S+"bytes to 0x"+R.toString(16)),e.cleanup()})})}else A<F?(A++,R=e.hex.data[A].address,w=0,B=2,e.loadAddress(R,y)):(console.log("Writing: done"),e.upload_procedure(5))};e.loadAddress(R,y);break;case 5:console.log("Verifying data ..."),v.firmware_flasher.flashingMessage(x.getMessage("stm32Verifying"),v.firmware_flasher.FLASH_MESSAGE_TYPES.NEUTRAL);for(var F=e.hex.data.length-1,L=0,R=e.hex.data[L].address,U=0,q=0,B=2,i=0;i<=F;i++)e.verify_hex.push([]);e.clearStatus(function(){e.loadAddress(R,function(){e.clearStatus(H)})});var H=function(){if(U<e.hex.data[L].bytes){var S=U+e.transferSize<=e.hex.data[L].bytes?e.transferSize:e.hex.data[L].bytes-U;e.controlTransfer("in",e.request.UPLOAD,B++,0,S,0,function(V,K){for(var G=0;G<V.length;G++)e.verify_hex[L].push(V[G]);R+=S,U+=S,q+=S,v.firmware_flasher.flashProgress((e.hex.bytes_total+q)/(e.hex.bytes_total*2)*100),H()})}else if(L<F)L++,R=e.hex.data[L].address,U=0,B=2,e.clearStatus(function(){e.loadAddress(R,function(){e.clearStatus(H)})});else{for(var z=!0,M=0;M<=F&&(z=e.verify_flash(e.hex.data[M].data,e.verify_hex[M]),!!z);M++);z?(console.log("Programming: SUCCESSFUL"),v.firmware_flasher.flashingMessage(x.getMessage("stm32ProgrammingSuccessful"),v.firmware_flasher.FLASH_MESSAGE_TYPES.VALID),e.leave()):(console.log("Programming: FAILED"),v.firmware_flasher.flashingMessage(x.getMessage("stm32ProgrammingFailed"),v.firmware_flasher.FLASH_MESSAGE_TYPES.INVALID),e.cleanup())}};break}};P.prototype.leave=function(){const t=this;let e;t.hex?e=t.hex.data[0].address:e=134217728,t.clearStatus(function(){t.loadAddress(e,function(){t.controlTransfer("out",t.request.DNLOAD,0,0,0,0,function(){t.controlTransfer("in",t.request.GETSTATUS,0,0,6,0,function(s){t.cleanup()})})})})};P.prototype.cleanup=function(){const t=this;t.releaseInterface(0),m.connect_lock=!1;var e=new Date().getTime()-t.upload_time_start;console.log("Script finished after: "+e/1e3+" seconds"),t.callback&&t.callback()};var je=new P,Z=function(){this.baud,this.options={},this.callback,this.hex,this.verify_hex,this.receive_buffer,this.bytes_to_read=0,this.read_callback,this.upload_time_start,this.upload_process_alive,this.status={ACK:121,NACK:31},this.command={get:0,get_ver_r_protect_s:1,get_ID:2,read_memory:17,go:33,write_memory:49,erase:67,extended_erase:68,write_protect:99,write_unprotect:115,readout_protect:130,readout_unprotect:146},this.available_flash_size=0,this.page_size=0,this.useExtendedErase=!1};Z.prototype.connect=function(t,e,s,n,r){var a=this;a.hex=s,a.baud=e,a.callback=r,a.options={no_reboot:!1,reboot_baud:!1,erase_chip:!1},n.no_reboot?a.options.no_reboot=!0:a.options.reboot_baud=n.reboot_baud,n.erase_chip&&(a.options.erase_chip=!0),a.options.no_reboot?$.connection.connect(t,{bitrate:a.baud,parityBit:"even",stopBits:"one"},function(i){i?(m.connect_lock=!0,a.initialize()):m.log(x.getMessage("failedToOpenSerialPort"))}):$.connection.connect(t,{bitrate:a.options.reboot_baud},function(i){if(i){console.log('Sending ascii "R" to reboot'),m.connect_lock=!0;var o=new ArrayBuffer(1),c=new Uint8Array(o);c[0]=82,$.connection.send(o,function(){$.connection.disconnect(function(h){if(h)var d=200,k=0,u=50,_=setInterval(function(){var f=function(){k++,k>u&&(clearInterval(_),m.log(x.getMessage("failedToFlash")+t))};he.check_usb_devices(function(p){if(p){clearInterval(_),je.connect(Oe,s,n);return}Je.getDevices(function(g){if(g&&g.includes(t)){$.connection.connect(t,{bitrate:a.baud,parityBit:"even",stopBits:"one"},function(b){b?(clearInterval(_),a.initialize()):(m.connect_lock=!1,f())});return}f()})})},d);else m.connect_lock=!1})})}else m.log(x.getMessage("failedToOpenSerialPort"))})};Z.prototype.initialize=function(){var t=this;t.receive_buffer=[],t.verify_hex=[],t.upload_time_start=new Date().getTime(),t.upload_process_alive=!1,t.progress_bar_e=l(".progress"),t.progress_bar_e.val(0),t.progress_bar_e.removeClass("valid invalid"),l('select[name="release"]').prop("disabled",!0),$.connection.addOnReceiveCallback(function(e){t.read(e)}),Q.add("STM32_timeout",function(){t.upload_process_alive?t.upload_process_alive=!1:(console.log("STM32 - timed out, programming failed ..."),l("span.progressLabel").text("STM32 - timed out, programming: FAILED"),t.progress_bar_e.addClass("invalid"),Q.remove("STM32_timeout"),t.upload_procedure(99))},2e3),t.upload_procedure(1)};Z.prototype.read=function(t){for(var e=new Uint8Array(t.data),s=0;s<e.length;s++)this.receive_buffer.push(e[s]);if(this.receive_buffer.length>=this.bytes_to_read&&this.bytes_to_read!=0){var e=this.receive_buffer.slice(0,this.bytes_to_read);this.receive_buffer.splice(0,this.bytes_to_read),this.bytes_to_read=0,this.read_callback(e)}};Z.prototype.retrieve=function(t,e){if(this.receive_buffer.length>=t){var s=this.receive_buffer.slice(0,t);this.receive_buffer.splice(0,t),e(s)}else this.bytes_to_read=t,this.read_callback=e};Z.prototype.send=function(t,e,s){this.upload_process_alive=!0;var n=new ArrayBuffer(t.length),r=new Uint8Array(n);r.set(t),this.bytes_to_read=e,this.read_callback=s,this.receive_buffer=[],$.connection.send(n,function(a){})};Z.prototype.verify_response=function(t,e){var s=this;if(t!=e[0]){var n="STM32 Communication failed, wrong response, expected: "+t+" (0x"+t.toString(16)+") received: "+e[0]+" (0x"+e[0].toString(16)+")";return console.error(n),l("span.progressLabel").text(n),s.progress_bar_e.addClass("invalid"),this.upload_procedure(99),!1}return!0};Z.prototype.verify_chip_signature=function(t){switch(t){case 1042:console.log("Chip recognized as F1 Low-density");break;case 1040:console.log("Chip recognized as F1 Medium-density"),this.available_flash_size=131072,this.page_size=1024;break;case 1044:console.log("Chip recognized as F1 High-density"),this.available_flash_size=262144,this.page_size=2048;break;case 1048:console.log("Chip recognized as F1 Connectivity line");break;case 1056:console.log("Chip recognized as F1 Medium-density value line");break;case 1064:console.log("Chip recognized as F1 High-density value line");break;case 1072:console.log("Chip recognized as F1 XL-density value line");break;case 1046:console.log("Chip recognized as L1 Medium-density ultralow power");break;case 1078:console.log("Chip recognized as L1 High-density ultralow power");break;case 1063:console.log("Chip recognized as L1 Medium-density plus ultralow power");break;case 1041:console.log("Chip recognized as F2 STM32F2xxxx");break;case 1088:console.log("Chip recognized as F0 STM32F051xx");break;case 1092:console.log("Chip recognized as F0 STM32F050xx");break;case 1043:console.log("Chip recognized as F4 STM32F40xxx/41xxx");break;case 1049:console.log("Chip recognized as F4 STM32F427xx/437xx, STM32F429xx/439xx");break;case 1074:console.log("Chip recognized as F3 STM32F37xxx, STM32F38xxx");break;case 1058:console.log("Chip recognized as F3 STM32F30xxx, STM32F31xxx"),this.available_flash_size=262144,this.page_size=2048;break}return this.available_flash_size>0?this.hex.bytes_total<this.available_flash_size?!0:(console.log("Supplied hex is bigger then flash available on the chip, HEX: "+this.hex.bytes_total+" bytes, limit = "+this.available_flash_size+" bytes"),!1):(console.log("Chip NOT recognized: "+t),!1)};Z.prototype.verify_flash=function(t,e){for(var s=0;s<t.length;s++)if(t[s]!=e[s])return console.log("Verification failed on byte: "+s+" expected: 0x"+t[s].toString(16)+" received: 0x"+e[s].toString(16)),!1;return console.log("Verification successful, matching: "+t.length+" bytes"),!0};Z.prototype.upload_procedure=function(t){var e=this;switch(t){case 1:l("span.progressLabel").text("Contacting bootloader ...");var s=0;Q.add("stm32_initialize_mcu",function(){e.send([127],1,function(p){p[0]==127||p[0]==e.status.ACK||p[0]==e.status.NACK?(Q.remove("stm32_initialize_mcu"),console.log("STM32 - Serial interface initialized on the MCU side"),e.upload_procedure(2)):(l("span.progressLabel").text("Communication with bootloader failed"),e.progress_bar_e.addClass("invalid"),Q.remove("stm32_initialize_mcu"),e.upload_procedure(99))}),s++>3&&(console.log("STM32 - no response from bootloader, disconnecting"),l("span.progressLabel").text("No response from the bootloader, programming: FAILED"),e.progress_bar_e.addClass("invalid"),Q.remove("stm32_initialize_mcu"),Q.remove("STM32_timeout"),e.upload_procedure(99))},250,!0);break;case 2:e.send([e.command.get,255],2,function(p){e.verify_response(e.status.ACK,p)&&e.retrieve(p[1]+1+1,function(g){console.log("STM32 - Bootloader version: "+(parseInt(g[0].toString(16))/10).toFixed(1)),e.useExtendedErase=g[7]==e.command.extended_erase,e.upload_procedure(3)})});break;case 3:e.send([e.command.get_ID,253],2,function(p){e.verify_response(e.status.ACK,p)&&e.retrieve(p[1]+1+1,function(g){var b=g[0]<<8|g[1];console.log("STM32 - Signature: 0x"+b.toString(16)),e.verify_chip_signature(b)?e.upload_procedure(4):e.upload_procedure(99)})});break;case 4:if(e.useExtendedErase){if(e.options.erase_chip){var n="Executing global chip erase (via extended erase)";console.log(n),l("span.progressLabel").text(n+" ..."),e.send([e.command.extended_erase,187],1,function(p){e.verify_response(e.status.ACK,p)&&e.send([255,255,0],1,function(g){e.verify_response(e.status.ACK,g)&&(console.log("Executing global chip extended erase: done"),e.upload_procedure(5))})})}else{var n="Executing local erase (via extended erase)";console.log(n),l("span.progressLabel").text(n+" ..."),e.send([e.command.extended_erase,187],1,function(g){if(e.verify_response(e.status.ACK,g)){var b=e.hex.data[e.hex.data.length-1].address+e.hex.data[e.hex.data.length-1].bytes-134217728,E=Math.ceil(b/e.page_size),T=[],A=0,w;w=E-1>>8,T.push(w),A^=w,w=E-1&255,T.push(w),A^=w;for(var C=0;C<E;C++)w=C>>8,T.push(w),A^=w,w=C&255,T.push(w),A^=w;T.push(A),console.log("Erasing. pages: 0x00 - 0x"+E.toString(16)+", checksum: 0x"+A.toString(16)),e.send(T,1,function(y){e.verify_response(e.status.ACK,y)&&(console.log("Erasing: done"),e.upload_procedure(5))})}})}break}if(e.options.erase_chip){var n="Executing global chip erase";console.log(n),l("span.progressLabel").text(n+" ..."),e.send([e.command.erase,188],1,function(g){e.verify_response(e.status.ACK,g)&&e.send([255,0],1,function(b){e.verify_response(e.status.ACK,b)&&(console.log("Erasing: done"),e.upload_procedure(5))})})}else{var n="Executing local erase";console.log(n),l("span.progressLabel").text(n+" ..."),e.send([e.command.erase,188],1,function(g){if(e.verify_response(e.status.ACK,g)){var b=e.hex.data[e.hex.data.length-1].address+e.hex.data[e.hex.data.length-1].bytes-134217728,E=Math.ceil(b/e.page_size),T=[],A=E-1;T.push(E-1);for(var w=0;w<E;w++)T.push(w),A^=w;T.push(A),e.send(T,1,function(C){e.verify_response(e.status.ACK,C)&&(console.log("Erasing: done"),e.upload_procedure(5))})}})}break;case 5:console.log("Writing data ..."),l("span.progressLabel").text("Flashing ...");var c=e.hex.data.length-1,r=0,d=e.hex.data[r].address,a=0,i=0,o=function(){if(a<e.hex.data[r].bytes){var p=a+256<=e.hex.data[r].bytes?256:e.hex.data[r].bytes-a;e.send([e.command.write_memory,206],1,function(g){if(e.verify_response(e.status.ACK,g)){var b=[d>>24,d>>16,d>>8,d],E=b[0]^b[1]^b[2]^b[3];e.send([b[0],b[1],b[2],b[3],E],1,function(T){if(e.verify_response(e.status.ACK,T)){var A=new Array(p+2);A[0]=p-1;for(var w=A[0],C=0;C<p;C++)A[C+1]=e.hex.data[r].data[a],w^=e.hex.data[r].data[a],a++;A[A.length-1]=w,d+=p,i+=p,e.send(A,1,function(y){e.verify_response(e.status.ACK,y)&&o()}),e.progress_bar_e.val(Math.round(i/(e.hex.bytes_total*2)*100))}})}})}else r<c?(r++,d=e.hex.data[r].address,a=0,o()):(console.log("Writing: done"),e.upload_procedure(6))};o();break;case 6:console.log("Verifying data ..."),l("span.progressLabel").text("Verifying ...");for(var c=e.hex.data.length-1,h=0,d=e.hex.data[h].address,k=0,u=0,_=0;_<=c;_++)e.verify_hex.push([]);var f=function(){if(k<e.hex.data[h].bytes){var p=k+256<=e.hex.data[h].bytes?256:e.hex.data[h].bytes-k;e.send([e.command.read_memory,238],1,function(E){if(e.verify_response(e.status.ACK,E)){var T=[d>>24,d>>16,d>>8,d],A=T[0]^T[1]^T[2]^T[3];e.send([T[0],T[1],T[2],T[3],A],1,function(w){if(e.verify_response(e.status.ACK,w)){var C=p-1;e.send([C,~C&255],1,function(y){e.verify_response(e.status.ACK,y)&&e.retrieve(p,function(F){for(var L=0;L<F.length;L++)e.verify_hex[h].push(F[L]);d+=p,k+=p,u+=p,f()})}),e.progress_bar_e.val(Math.round((e.hex.bytes_total+u)/(e.hex.bytes_total*2)*100))}})}})}else if(h<c)h++,d=e.hex.data[h].address,k=0,f();else{for(var g=!0,b=0;b<=c&&(g=e.verify_flash(e.hex.data[b].data,e.verify_hex[b]),!!g);b++);g?(console.log("Programming: SUCCESSFUL"),l("span.progressLabel").text("Programming: SUCCESSFUL"),e.progress_bar_e.addClass("valid"),e.upload_procedure(7)):(console.log("Programming: FAILED"),l("span.progressLabel").text("Programming: FAILED"),e.progress_bar_e.addClass("invalid"),e.upload_procedure(99))}};f();break;case 7:console.log("Sending GO command: 0x8000000"),e.send([e.command.go,222],1,function(p){if(e.verify_response(e.status.ACK,p)){var g=134217728,b=[g>>24,g>>16,g>>8,g],E=b[0]^b[1]^b[2]^b[3];e.send([b[0],b[1],b[2],b[3],E],1,function(T){e.verify_response(e.status.ACK,T)&&e.upload_procedure(99)})}});break;case 99:Q.remove("STM32_timeout"),$.connection.disconnect(function(p){m.connect_lock=!1,l('select[name="release"]').prop("disabled",!1);var g=new Date().getTime()-e.upload_time_start;console.log("Script finished after: "+g/1e3+" seconds"),e.callback&&e.callback()});break}};var Nt=new Z;v.firmware_flasher={};v.firmware_flasher.initialize=function(t){m.active_tab!="firmware_flasher"&&(m.active_tab="firmware_flasher");var e=!1,s=!1,n="inav.hex";et(async()=>{const{default:r}=await import("./firmware_flasher-TzGugGoE.js");return{default:r}},[],import.meta.url).then(({default:r})=>m.load(r,function(){x.localize();function a(){l(".load_remote_file").text(x.getMessage("firmwareFlasherButtonLoadOnline")).removeClass("disabled")}function i(u,_){const f=new Worker(new URL(""+new URL("hex_parser-CLbWyu7D.js",import.meta.url).href,import.meta.url));f.onmessage=function(p){_(p.data)},f.postMessage(u)}function o(u){var _=/^inav-(\d+)([\d.]+)-(ci|dev)-(\d{4})(\d{2})(\d{2})-(\d+)-(\w+)$/,f=_.exec(u);return f?f[1]:(console.log(u+" not matched"),0)}function c(u){var _=/^inav_(\d+)([\d.]+)_([A-Za-z0-9_]+)_(ci|dev)-(\d{4})(\d{2})(\d{2})-(\w+)\.(hex)$/,f=_.exec(u);return f?{raw_target:f[3],target:f[3].replace("_"," "),format:f[9],version:f[1]+f[2],major:f[1]}:(console.log(u+" not matched"),null)}function h(u){var _=/inav_([\d.]+(?:-rc\d+)?)?_?([^.]+)\.(.*)/,f=_.exec(u);return f?{raw_target:f[2],target:f[2].replace("_"," "),format:f[3]}:null}l("input.show_development_releases").on("click",function(){let u=String(l('select[name="board"]').val());m.log(x.getMessage("selectedTarget")+u),d(),m.log(x.getMessage("toggledRCs")),u==="0"?v.firmware_flasher.getTarget():(l('select[name="board"] option[value='+u+"]").attr("selected","selected"),l('select[name="board"]').trigger("change"))}),l(".target_search").on("input",function(){var u=l(".target_search").val().toLocaleLowerCase();l("#board_targets option").each(function(_){var f=l(this);u.length>0&&_!==0?f.text().toLowerCase().includes(u)||f.val().toLowerCase().includes(u)?f.show():f.hide():f.show()})});var d=function(u){const _=performance.now();var f=l('select[name="board"]').empty(),p=l('select[name="firmware_version"]').empty(),g=l("input.show_development_releases").is(":checked");f.append(l("<option value='0'>{0}</option>".format(x.getMessage("firmwareFlasherOptionLabelSelectBoard")))),p.append(l("<option value='0'>{0}</option>".format(x.getMessage("firmwareFlasherOptionLabelSelectFirmwareVersion"))));var b={},E=[],T=[];if(v.firmware_flasher.releasesData.forEach(function(y){y.assets.forEach(function(F){var L=h(F.name);!g&&y.prerelease||!L||l.inArray(L.target,T)==-1&&T.push(L.target)})}),g){var A={};v.firmware_flasher.devReleasesData.forEach(function(y){y.assets.forEach(function(F){var L=c(F.name);L&&l.inArray(L.target,T)==-1&&T.push(L.target)})})}if(E=T.sort(),E.forEach(function(y){b[y]=[]}),v.firmware_flasher.releasesData.forEach(function(y){var F=/v?(.*)/,L=F.exec(y.tag_name);L[1],y.assets.forEach(function(R){var U=h(R.name);if(!(!g&&y.prerelease||!U)&&U.format=="hex"){var q=new Date(y.published_at),B="{0}-{1}-{2} {3}:{4}".format(q.getFullYear(),q.getMonth()+1,q.getDate(),q.getUTCHours(),q.getMinutes()),H={releaseUrl:y.html_url,name:_e.clean(y.name),version:y.tag_name,url:R.browser_download_url,file:R.name,raw_target:U.raw_target,target:U.target,date:B,notes:y.body,status:y.prerelease?"release-candidate":"stable"};b[U.target].push(H)}})}),g&&v.firmware_flasher.devReleasesData){var A={};v.firmware_flasher.devReleasesData.forEach(function(F){var L=o(F.name);if(L in A||(A[L]=0),!(A[L]>=10)){A[L]++;var R=/v?(.*)/,U=R.exec(F.tag_name);U[1],F.assets.forEach(function(q){var B=c(q.name);if(!(!g&&F.prerelease||!B)&&B.format=="hex"){var H=new Date(F.published_at),S="{0}-{1}-{2} {3}:{4}".format(H.getFullYear(),H.getMonth()+1,H.getDate(),H.getUTCHours(),H.getMinutes()),z={releaseUrl:F.html_url,name:_e.clean(F.name),version:F.tag_name,url:q.browser_download_url,file:q.name,raw_target:B.raw_target,target:B.target,date:S,notes:F.body,status:F.prerelease?"nightly":"stable"};b[B.target].push(z)}})}})}var w=[];Object.keys(b).sort().forEach(function(y,F){var L=b[y];L.forEach(function(R){if(l.inArray(y,w)==-1){w.push(y);var U=l("<option value='{0}'>{1}</option>".format(R.raw_target,R.target)).data("summary",R);f.append(U)}})}),v.firmware_flasher.releases=b;const C=performance.now();console.log(`buildBoardOptions: ${C-_} ms`)};l.get("https://api.github.com/repos/iNavFlight/inav-nightly/releases?per_page=50",function(u){v.firmware_flasher.devReleasesData=u}).fail(function(u){v.firmware_flasher.devReleasesData={},u.responseJSON&&m.log("<b>GITHUB Query Failed: <code>{0}</code></b>".format(u.responseJSON.message)),l('select[name="board"]').empty().append('<option value="0">Offline</option>'),l('select[name="firmware_version"]').empty().append('<option value="0">Offline</option>'),l("a.auto_select_target").addClass("disabled")}),l.get("https://api.github.com/repos/iNavFlight/inav/releases?per_page=10",function(u){v.firmware_flasher.releasesData=u,d(),l('select[name="board"]').on("change",function(){l("a.load_remote_file").addClass("disabled");var _=l(this).children("option:selected").text();if(!m.connect_lock){l(".progress").val(0).removeClass("valid invalid"),l("span.progressLabel").text(x.getMessage("firmwareFlasherLoadFirmwareFile")),l("div.git_info").slideUp(),l("div.release_info").slideUp(),l("a.flash_firmware").addClass("disabled");var f=l('select[name="firmware_version"]').empty();_==0?f.append(l("<option value='0'>{0}</option>".format(x.getMessage("firmwareFlasherOptionLabelSelectFirmwareVersion")))):f.append(l("<option value='0'>{0} {1}</option>".format(x.getMessage("firmwareFlasherOptionLabelSelectFirmwareVersionFor"),_))),v.firmware_flasher.releases[_].forEach(function(p){var g=l("<option value='{0}'>{0} - {1} - {2} ({3})</option>".format(p.version,p.target,p.date,p.status)).data("summary",p);f.append(g)})}}),l("a.auto_select_target").removeClass("disabled"),v.firmware_flasher.getTarget()}).fail(function(u){u.responseJSON&&m.log("<b>GITHUB Query Failed: <code>{0}</code></b>".format(u.responseJSON.message)),l('select[name="board"]').empty().append('<option value="0">Offline</option>'),l('select[name="firmware_version"]').empty().append('<option value="0">Offline</option>'),l("a.auto_select_target").addClass("disabled")}),l("a.load_file").on("click",function(){var u={filters:[{name:"HEX file",extensions:["hex"]}]};Re.showOpenDialog(u).then(_=>{if(_.canceled)return;let f;_.filePaths.length==1&&(f=_.filePaths[0]),l("div.git_info").slideUp(),console.log("Loading file from: "+f),window.electronAPI.readFile(f).then(p=>{if(p.error){console.log("Error loading local file",p.erroe);return}console.log("File loaded"),i(p.data.toString(),function(g){s=g,s?(l("a.flash_firmware").removeClass("disabled"),l("span.progressLabel").text("Loaded Local Firmware: ("+s.bytes_total+" bytes)")):l("span.progressLabel").text(x.getMessage("firmwareFlasherHexCorrupted"))})})})}),l('select[name="firmware_version"]').on("change",function(u){l("div.release_info").slideUp(),l("a.flash_firmware").addClass("disabled"),u.target.value=="0"?l("a.load_remote_file").addClass("disabled"):a()}),l("a.load_remote_file").on("click",function(){if(l('select[name="firmware_version"]').val()=="0"){m.log(x.getMessage("noFirmwareSelectedToLoad"));return}function u(p,g){e=p,i(e,function(b){if(s=b,s){l("span.progressLabel").html('<a class="save_firmware" href="#" title="Save Firmware">Loaded Online Firmware: ('+s.bytes_total+" bytes)</a>"),l("a.flash_firmware").removeClass("disabled"),g.commit&&l.get("https://api.github.com/repos/iNavFlight/inav/commits/"+g.commit,function(w){var w=w,C=new Date(w.commit.author.date),y=C.getTimezoneOffset()/60,F;F=C.getFullYear()+"."+("0"+(C.getMonth()+1)).slice(-2)+"."+("0"+C.getDate()).slice(-2),F+=" @ "+("0"+C.getHours()).slice(-2)+":"+("0"+C.getMinutes()).slice(-2),F+=y>0?" GMT+"+y:" GMT"+y,l("div.git_info .committer").text(w.commit.author.name),l("div.git_info .date").text(F),l("div.git_info .hash").text(w.sha.slice(0,7)).prop("href","https://api.github.com/repos/iNavFlight/inav/commit/"+w.sha),l("div.git_info .message").text(w.commit.message),l("div.git_info").slideDown()}),l("div.release_info .target").text(g.target);var E=l("div.release_info .status");g.status=="release-candidate"?l("div.release_info .status").html(x.getMessage("firmwareFlasherReleaseStatusReleaseCandidate")).show():E.hide(),l("div.release_info .name").text(g.name).prop("href",g.releaseUrl),l("div.release_info .date").text(g.date),l("div.release_info .status").text(g.status),l("div.release_info .file").text(g.file).prop("href",g.url);var T=I.parse(g.notes);l("div.release_info .notes").html(T),l("div.release_info .notes a").each(function(){l(this).attr("target","_blank")}),l("div.release_info").slideDown()}else l("span.progressLabel").text(x.getMessage("firmwareFlasherHexCorrupted"))})}function _(){l("span.progressLabel").text(x.getMessage("firmwareFlasherFailedToLoadOnlineFirmware")),l("a.flash_firmware").addClass("disabled"),a()}var f=l('select[name="firmware_version"] option:selected').data("summary");f?(n=f.file,l(".load_remote_file").text(x.getMessage("firmwareFlasherButtonLoading")).addClass("disabled"),l.get(f.url,function(p){a(),u(p,f)}).fail(_)):l("span.progressLabel").text(x.getMessage("firmwareFlasherFailedToLoadOnlineFirmware"))}),l("a.flash_firmware").on("click",function(){if(!l(this).hasClass("disabled")&&!m.connect_lock)if(s!=!1){var u={};if(l("input.erase_chip").is(":checked")&&(u.erase_chip=!0),String(l("div#port-picker #port").val())!="DFU")if(String(l("div#port-picker #port").val())!="0"){var _=String(l("div#port-picker #port").val()),f;switch(m.operating_system){case"Windows":case"MacOS":case"ChromeOS":case"Linux":case"UNIX":f=921600;break;default:f=115200}l("input.updating").is(":checked")?u.no_reboot=!0:u.reboot_baud=parseInt(l("div#port-picker #baud").val()),l("input.flash_manual_baud").is(":checked")&&(f=parseInt(l("#flash_manual_baud_rate").val())),Nt.connect(_,f,s,u)}else console.log("Please select valid serial port"),m.log(x.getMessage("selectValidSerialPort"));else je.connect(Oe,s,u)}else l("span.progressLabel").text(x.getMessage("firmwareFlasherFirmwareNotLoaded"))}),l(document).on("click","span.progressLabel a.save_firmware",function(){var u={defaultPath:n,filters:[{name:"HEX File",extensions:["hex"]}]};Re.showSaveDialog(u).then(_=>{if(_.canceled)return;fs.writeFileSync(_.filePath,e,p=>{if(p)return m.log(x.getMessage("ErrorWritingFile")),console.error(p)});let f=String(_.filePath.split("\\").pop().split("/").pop());m.log(f+x.getMessage("savedSuccessfully"))})}),O.storeGet("no_reboot_sequence",!1)?(l("input.updating").prop("checked",!0),l(".flash_on_connect_wrapper").show()):l("input.updating").prop("checked",!1),l("input.updating").on("change",function(){var u=l(this).is(":checked");u?l(".flash_on_connect_wrapper").show():(l("input.flash_on_connect").prop("checked",!1).trigger("change"),l(".flash_on_connect_wrapper").hide()),O.storeSet("no_reboot_sequence",u)}),l("input.updating").trigger("change"),O.storeGet("flash_manual_baud",!1)?l("input.flash_manual_baud").prop("checked",!0):l("input.flash_manual_baud").prop("checked",!1),l("input.flash_manual_baud").on("change",function(){var u=l(this).is(":checked");O.storeSet("flash_manual_baud",u)}),l("input.flash_manual_baud").trigger("change");var k=O.storeGet("flash_manual_baud_rate","");l("#flash_manual_baud_rate").val(k),l("#flash_manual_baud_rate").on("change",function(){var u=parseInt(l("#flash_manual_baud_rate").val());O.storeSet("flash_manual_baud_rate",u)}),l("input.flash_manual_baud_rate").trigger("change"),O.storeGet("flash_on_connect",!1)?l("input.flash_on_connect").prop("checked",!0):l("input.flash_on_connect").prop("checked",!1),l("input.flash_on_connect").on("change",function(){var u=l(this).is(":checked");if(u){var _=function(){he.port_detected("flash_detected_device",function(f){var p=f[0];m.connect_lock?m.log("Detected <strong>"+p+"</strong> - previous device still flashing, please replug to try again"):(m.log("Detected: <strong>"+p+"</strong> - triggering flash on connect"),console.log("Detected: "+p+" - triggering flash on connect"),we.add("initialization_timeout",function(){l("a.flash_firmware").trigger("click")},100)),_()},!1,!0)};_()}else he.flush_callbacks();O.storeSet("flash_on_connect",u)}).trigger("change"),O.storeGet("erase_chip",!1)?l("input.erase_chip").prop("checked",!0):l("input.erase_chip").prop("checked",!1),l("input.erase_chip").on("change",async function(){O.storeSet("erase_chip",l(this).is(":checked"))}),l("input.erase_chip").trigger("change"),l(document).keypress(function(u){u.which==13&&l("a.flash_firmware").trigger("click")}),l("a.auto_select_target").on("click",function(){v.firmware_flasher.getTarget()}),m.content_ready(t)}))};v.firmware_flasher.FLASH_MESSAGE_TYPES={NEUTRAL:"NEUTRAL",VALID:"VALID",INVALID:"INVALID",ACTION:"ACTION"};v.firmware_flasher.flashingMessage=function(t,e){let s=this,n=l("span.progressLabel");switch(e){case s.FLASH_MESSAGE_TYPES.VALID:n.removeClass("invalid actionRequired").addClass("valid");break;case s.FLASH_MESSAGE_TYPES.INVALID:n.removeClass("valid actionRequired").addClass("invalid");break;case s.FLASH_MESSAGE_TYPES.ACTION:n.removeClass("valid invalid").addClass("actionRequired");break;case s.FLASH_MESSAGE_TYPES.NEUTRAL:default:n.removeClass("valid invalid actionRequired");break}return t!=null&&n.html(t),s};v.firmware_flasher.flashProgress=function(t){return l(".progress").val(t),this};v.firmware_flasher.cleanup=function(t){he.flush_callbacks(),l(document).unbind("keypress"),l(document).off("click","span.progressLabel a"),t&&t()};v.firmware_flasher.getTarget=function(){m.log(x.getMessage("automaticTargetSelect"));var t=parseInt(l("#baud").val()),e=l("#port").find("option:selected").data().isManual?l("#port-override").val():String(l("#port").val());e!=="DFU"?!e||e=="0"?m.log(x.getMessage("targetPrefetchFailNoPort")):(console.log("Connecting to: "+e),m.connecting_to=e,e=="tcp"||e=="udp"?$.connection.connect($portOverride.val(),{},v.firmware_flasher.onOpen):$.connection.connect(e,{bitrate:t},v.firmware_flasher.onOpen)):m.log(x.getMessage("targetPrefetchFailDFU"))};v.firmware_flasher.onOpen=async function(t){if(t){m.connected_to=m.connecting_to,m.connecting_to=!1;var e=O.storeGet("last_used_port","");e?e!=m.connected_to&&O.storeSet("last_used_port",m.connected_to):O.storeSet("last_used_port",m.connected_to),O.storeSet("last_used_bps",$.connection.bitrate),O.storeSet("wireless_mode_enabled",l("#wireless-mode").is(":checked")),$.connection.addOnReceiveListener(tt.read_serial),we.add("connecting",function(){$.connectionValid||(m.log(x.getMessage("targetPrefetchFail")+x.getMessage("noConfigurationReceived")),v.firmware_flasher.closeTempConnection())},1e4),X.resetState(),J.protocolVersion=J.constants.PROTOCOL_V2,J.send_message(ae.MSP_API_VERSION,!1,!1,function(){if(X.CONFIG.apiVersion==="0.0.0"){GUI_control.prototype.log("Cannot prefetch target: <span style='color: red; font-weight: bolder'><strong>"+x.getMessage("illegalStateRestartRequired")+"</strong></span>"),X.restartRequired=!0;return}J.send_message(ae.MSP_FC_VARIANT,!1,!1,function(){X.CONFIG.flightControllerIdentifier=="INAV"?J.send_message(ae.MSP_FC_VERSION,!1,!1,function(){_e.lt(X.CONFIG.flightControllerVersion,"5.0.0")?(m.log(x.getMessage("targetPrefetchFailOld")),v.firmware_flasher.closeTempConnection()):rt.getCraftName(function(s){s&&(X.CONFIG.name=s),v.firmware_flasher.onValidFirmware()})}):(m.log(x.getMessage("targetPrefetchFailNonINAV")),v.firmware_flasher.closeTempConnection())})})}else{m.log(x.getMessage("targetPrefetchFail")+x.getMessage("serialPortOpenFail"));return}};v.firmware_flasher.onValidFirmware=function(){J.send_message(ae.MSP_BUILD_INFO,!1,!1,function(){J.send_message(ae.MSP_BOARD_INFO,!1,!1,function(){l('select[name="board"] option[value='+X.CONFIG.target+"]").attr("selected","selected"),m.log(x.getMessage("targetPrefetchsuccessful")+X.CONFIG.target),v.firmware_flasher.closeTempConnection(),l('select[name="board"]').trigger("change")})})};v.firmware_flasher.closeTempConnection=function(){we.killAll(),Q.killAll(["global_data_refresh","msp-load-update","ltm-connection-check"]),xe.flush(),xe.freeHardLock(),xe.freeSoftLock(),st.flush(),$.connection.emptyOutputBuffer(),$.connectionValid=!1,m.connected_to=!1,$.connection.disconnect(),J.disconnect_cleanup()};
