import{T as c,G as d,e as S,f as k,M as A,_ as L,i as h,$ as o,z as _,C as u,et as s,eu as M,F as D,t as m,ev as C,k as I}from"./index--BqaKNiR.js";import{d as B}from"./dialog-CY10jn-b.js";c.cli={lineDelayMs:50,profileSwitchDelayMs:100,outputHistory:"",cliBuffer:"",GUI:{snippetPreviewWindow:null}};function b(i){return i.replace(/^# /,"")}function T(i,e){for(var l=0,r=0;r<e.length&&i[r]===e[r];r++)l++;return e.length-l}function R(i,e,l){return"".repeat(l)+i.substring(e.length-l,i.length)}function w(i,e){const l=b(e),r=new RegExp("^"+l,"g");if(i.match(r))return i.replace(r,"");const t=T(i,l);return R(i,l,t)}c.cli.initialize=function(i){var e=this;d.active_tab!="cli"&&(d.active_tab="cli"),S.flush(),k.flush(),A.callbacks_cleanup(),e.outputHistory="",e.cliBuffer="";function l(r){e.history.add(r.trim());var t=r.split(`
`);return t.reduce((n,a,f)=>n.then(v=>new Promise(g=>{m.add("CLI_send_slowly",()=>{let p=c.cli.lineDelayMs;a.toLowerCase().includes("_profile")&&(p=c.cli.profileSwitchDelayMs),t.length===f+1&&c.cli.cliBuffer&&(a=w(a,c.cli.cliBuffer)),c.cli.sendLine(a,()=>{g(p)})},v)})),Promise.resolve(0))}L(async()=>{const{default:r}=await import("./cli-ioRakTtb.js");return{default:r}},[],import.meta.url).then(({default:r})=>d.load(r,function(){h.localize(),o(".cliDocsBtn").attr("href",_.docsTreeLocation+"Settings.md"),u.cliActive=!0;var t=o('.tab-cli textarea[name="commands"]');if(s.initialize(t,e.sendLine.bind(e),y),o(s).on("build:start",function(){t.val("").attr("placeholder",h.getMessage("cliInputPlaceholderBuilding")).prop("disabled",!0)}),o(s).on("build:stop",function(){t.attr("placeholder",h.getMessage("cliInputPlaceholder")).prop("disabled",!1).focus()}),o(".tab-cli .save").on("click",function(){var n="cli",a="txt",f=M(D.CONFIG,n,a),v={defaultPath:f,filters:[{name:a.toUpperCase(),extensions:[a]},{name:n.toUpperCase(),extensions:[n]}]};B.showSaveDialog(v).then(g=>{if(g.canceled){d.log(h.getMessage("cliSaveToFileAborted"));return}window.electronAPI.writeFile(g.filePath,e.outputHistory).then(p=>{if(p)return d.log(h.getMessage("ErrorWritingFile")),console.error(p)}),d.log(h.getMessage("FileSaved"))}).catch(g=>{console.log(g)})}),o(".tab-cli .exit").on("click",function(){e.send(w(`exit
`,c.cli.cliBuffer))}),o(".tab-cli .savecmd").on("click",function(){e.send(w(`save
`,c.cli.cliBuffer))}),o(".tab-cli .msc").on("click",function(){e.send(w(`msc
`,c.cli.cliBuffer))}),o(".tab-cli .diffall").on("click",function(){e.outputHistory="",o(".tab-cli .window .wrapper").empty(),e.send(w(`diff all
`,c.cli.cliBuffer))}),o(".tab-cli .clear").on("click",function(){e.outputHistory="",o(".tab-cli .window .wrapper").empty()}),o(".tab-cli .copy").hide(),o(".tab-cli .load").on("click",function(){var n={filters:[{name:"CLI/TXT",extensions:["cli","txt"]},{name:"ALL",extensions:["*"]}]};B.showOpenDialog(n).then(a=>{if(a.canceled){console.log("No file selected");return}let f=o("#snippetpreviewcontent textarea#preview");function v(){const p=f.val();l(p),e.GUI.snippetPreviewWindow.close()}function g(p){e.GUI.snippetPreviewWindow||(e.GUI.snippetPreviewWindow=new I("Modal",{id:"snippetPreviewWindow",width:"auto",height:"auto",closeButton:"title",animation:!1,isolateScroll:!1,title:h.getMessage("cliConfirmSnippetDialogTitle"),content:o("#snippetpreviewcontent"),onCreated:()=>o("#snippetpreviewcontent a.confirm").on("click",v)})),f.val(p),e.GUI.snippetPreviewWindow.open()}a.filePaths.length==1&&window.electronAPI.readFile(a.filePaths[0]).then(p=>{if(p.error){d.log(h.getMessage("ErrorReadingFile")),console.error(p.error);return}g(p.data)})}).catch(a=>{console.log(a)})}),t.on("keydown",function(n){if(n.which==9)if(n.preventDefault(),s.isEnabled())!s.isOpen()&&!s.isBuilding()&&s.openLater(!0);else{const v=t.val().split(`
`).pop(),g=w(v,e.cliBuffer);g&&(e.sendAutoComplete(g),t.val(""))}}),t.on("keypress",function(n){if(n.which==13){if(n.preventDefault(),s.isBuilding())return;var f=t.val();e.history.add(f.trim()),f.trim().toLowerCase()=="cls"||f.trim().toLowerCase()=="clear"?(e.outputHistory="",o(".tab-cli .window .wrapper").empty()):l(f),t.val("")}}),t.on("keyup",function(n){var a={38:!0},f={40:!0};s.isOpen()||(n.keyCode in a&&t.val(e.history.prev()),n.keyCode in f&&t.val(e.history.next()))}),t.focus(),m.add("enter_cli",function(){var a=new ArrayBuffer(1),f=new Uint8Array(a);f[0]=35,u.connection.send(a)},250),u.connection.type==C.UDP&&(u.connection.isCli=!0),u.connection.type==C.BLE){let n=u.connection.deviceDescription.delay;n>0&&m.add("cli_delay",()=>{e.send(w("cli_delay "+n+`
`,c.cli.cliBuffer)),e.send(w("# "+h.getMessage("connectionBleCliEnter")+`
`,c.cli.cliBuffer))},400)}d.content_ready(i)}))};c.cli.history={history:[],index:0};c.cli.history.add=function(i){this.history.push(i),this.index=this.history.length};c.cli.history.prev=function(){return this.index>0&&(this.index-=1),this.history[this.index]};c.cli.history.next=function(){return this.index<this.history.length&&(this.index+=1),this.history[this.index-1]};const U=8,O=10,E=13;function y(i){o(".tab-cli .window .wrapper").append(i),o(".tab-cli .window").scrollTop(o(".tab-cli .window .wrapper").height())}function x(i){if(s.isBuilding()){s.builderParseLine(i);return}i.startsWith("### ERROR: ")?y('<span class="error_message">'+i+"</span><br>"):y(i+"<br>")}function P(i){o(".tab-cli textarea").val(i)}c.cli.read=function(i){for(var e=new Uint8Array(i.data),l="",r=0,t=0;t<e.length;t++){const n=String.fromCharCode(e[t]);if(!u.cliValid){l+=n,y(n);continue}if(e[t]==27&&!r&&(r=3),r){r--;continue}switch(e[t]){case O:d.operating_system==="Windows"&&(x(this.cliBuffer),this.cliBuffer="");break;case E:d.operating_system!=="Windows"&&(x(this.cliBuffer),this.cliBuffer="");break;case 60:this.cliBuffer+="&lt";break;case 62:this.cliBuffer+="&gt";break;case U:this.cliBuffer=this.cliBuffer.slice(0,-1);break;default:this.cliBuffer+=n}s.isBuilding()||(this.outputHistory+=n),this.cliBuffer=="Rebooting"&&(u.cliActive=!1,u.cliValid=!1,d.log(h.getMessage("cliReboot")),d.log(h.getMessage("deviceRebooting")),d.handleReconnect())}!u.cliValid&&l.indexOf("CLI")!==-1&&(d.log(h.getMessage("cliEnter")),u.cliValid=!0,s.isEnabled()&&!s.isBuilding()&&s.builderStart()),s.isEnabled()||P(b(this.cliBuffer)),P(b(this.cliBuffer))};c.cli.sendLine=function(i,e){this.send(i+`
`,e)};c.cli.sendAutoComplete=function(i,e){this.send(i+"	",e)};c.cli.send=function(i,e){for(var l=new ArrayBuffer(i.length),r=new Uint8Array(l),t=0;t<i.length;t++)r[t]=i.charCodeAt(t);u.connection.send(l,e)};c.cli.cleanup=function(i){if(!(u.connectionValid&&u.cliValid&&u.cliActive)){i&&i();return}this.send(w("exit\r",this.cliBuffer),function(e){m.add("waiting_for_bootup",function(){i&&i()},1e3),u.cliActive=!1,s.cleanup(),o(s).off()})};
