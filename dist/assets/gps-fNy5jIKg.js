import{G as c,i as d,z as p,T as x,p as X,m as P,n as ne,M as H,d as B,$ as a,_ as l,F as e,x as K,l as R,E as Ae,H as k,X as j,I as he,J as $,K as be,k as we,b as re,S as Pe,s as xe,o as Ee,N as ie,Q as le,R as ue,U as ce,W as pe,Y as de,Z as De,a0 as ye}from"./index--BqaKNiR.js";import{T as Te}from"./TileWMS-Ojl1fCoy.js";import{d as ee}from"./dialog-CY10jn-b.js";var Q=(function(){var A={},E=null;const T="mga",Y="gps,gal,bds,glo,qzss",V=["online-live1.services.u-blox.com","online-live2.services.u-blox.com"],Z=5,W="gps,gal,bds,glo",q="gps,gal,bds,glo",J=["offline-live1.services.u-blox.com","offline-live2.services.u-blox.com"];A.init=function(){};var N,I,G,h,D,y,m,v,f;function L(){N=!1,I=!1,G=!1,h=!1,D=!1,y=!1,m=0,v=0,f=[]}function i(r){let g=new DataView(r);var u=[];L();for(var o=0;o<g.byteLength;++o){let n=g.getUint8(o);if(!N)if(n==181){N=!0,f.push(n);continue}else{L();continue}if(!I)if(n==98){I=!0,f.push(n);continue}else{L();continue}if(!G){G=!0,f.push(n);continue}if(!h){h=!0,f.push(n);continue}if(!D){D=!0,m=n,f.push(n);continue}if(!y){y=!0,m=n<<8|m,m+=2,f.push(n);continue}if(v<m-1){v=v+1,f.push(n);continue}if(v==m-1){v=v+1,f.push(n),u.push(f),L();continue}}return u}function b(r,g,u){const o=new XMLHttpRequest;o.open("GET",r,!0),o.responseType="arraybuffer",g!=null&&(o.onload=n=>{if(o.status==200)g(o.response);else if(u!=null){var U=new TextDecoder("utf-8");c.log(`http status: ${o.status}: ${U.decode(o.response)}`),u(o.response)}}),u!=null&&(o.onerror=n=>{new TextDecoder("utf-8"),c.log(d.getMessage("gpsAssistnowLoadDataError")+": Received an unkonwn error when trying to download data."),u("Unknown error.")});try{o.send(null)}catch(n){c.alert(d.getMessage("gpsAssistnowLoadDataError")),c.log(d.getMessage("gpsAssistnowLoadDataError")+":"+n.toString()),console.log(d.getMessage("gpsAssistnowLoadDataError")+":"+JSON.stringify(n))}}function F(r){ee.alert(d.getMessage("gpsAssistnowLoadDataError")),console.log(JSON.stringify(r))}return A.loadAssistnowOffline=function(r){let g=`https://${J[0]}/GetOfflineData.ashx?token=${p.assistnowApiKey};gnss=${W};format=${T};period=${Z};resolution=1;alm=${q};`;function u(o){p.assistnowOfflineData==null||Date.now()/1e3-p.assistnowOfflineDate>3600*24*3?(console.log("AssistnowOfflineData older than 3 days, refreshing."),p.assistnowOfflineData=i(o),p.assistnowOfflineDate=Math.floor(Date.now()/1e3),p.saveAssistnowData()):console.log("AssitnowOfflineData newer than 3 days. Re-using."),r(p.assistnowOfflineData)}b(g,u,F)},A.loadAssistnowOnline=function(r){let g=`https://${V[0]}/GetOnlineData.ashx?token=${p.assistnowApiKey};gnss=${Y};datatype=eph,alm,aux,pos;format=${T}`;function u(o){E=i(o),r(E)}b(g,u,F)},A.isAssistnowDataRelevant=function(r,g,u,o){if(r[2]==19&&r[3]==32){if(r[10]+2e3==g&&r[11]==u&&r[12]==o)return!0}else return!0;return!1},A})();x.gps={};x.gps.initialize=function(A){c.active_tab!="gps"&&(c.active_tab="gps");const E={0:{iconNum:14,name:"No info"},1:{iconNum:1,name:"Light"},2:{iconNum:1,name:"Small"},3:{iconNum:2,name:"Large"},4:{iconNum:14,name:"High vortex large"},5:{iconNum:5,name:"Heavy"},6:{iconNum:14,name:"Manuv"},7:{iconNum:13,name:"Rotorcraft"},8:{iconNum:14,name:"Unassigned"},9:{iconNum:6,name:"Glider"},10:{iconNum:7,name:"Lighter air"},11:{iconNum:15,name:"Parachute"},12:{iconNum:1,name:"Ultra light"},13:{iconNum:14,name:"Unassigned 2"},14:{iconNum:8,name:"UAV"},15:{iconNum:14,name:"Space"},16:{iconNum:14,name:"Unassigned 3"},17:{iconNum:9,name:"Surface"},18:{iconNum:10,name:"Service surface"},19:{iconNum:12,name:"Pint obstacle"}};var T=new X,Y=[P.loadFeatures,P.loadSerialPorts,P.loadMiscV2];T.setChain(Y),T.setExitPoint(N),T.execute();var V=new X,Z=[P.saveMiscV2,P.saveSerialPorts,W,P.saveToEeprom];function W(i){ne.saveInputs(i)}V.setChain(Z),V.setExitPoint(q);function q(){c.log(d.getMessage("configurationEepromSaved")),c.tab_switch_cleanup(function(){H.send_message(B.MSP_SET_REBOOT,!1,!1,function(){c.log(d.getMessage("deviceRebooting")),c.handleReconnect(a(".tab_gps a"))})})}async function J(){for(let i=0;i<=19;i++)E[i].icon=(await Ee(Object.assign({"../resources/adsb/adsb_1.png":()=>l(()=>import("./adsb_1-Ceu8j1um.js"),[],import.meta.url),"../resources/adsb/adsb_10.png":()=>l(()=>import("./adsb_10-DRzRu8yW.js"),[],import.meta.url),"../resources/adsb/adsb_11.png":()=>l(()=>import("./adsb_11-DbEpUJzB.js"),[],import.meta.url),"../resources/adsb/adsb_12.png":()=>l(()=>import("./adsb_12-DCTFYybg.js"),[],import.meta.url),"../resources/adsb/adsb_13.png":()=>l(()=>import("./adsb_13-DqeTLnfG.js"),[],import.meta.url),"../resources/adsb/adsb_14.png":()=>l(()=>import("./adsb_14-DANZ4k9-.js"),[],import.meta.url),"../resources/adsb/adsb_15.png":()=>l(()=>import("./adsb_15-DcMdBaLk.js"),[],import.meta.url),"../resources/adsb/adsb_2.png":()=>l(()=>import("./adsb_2-Cf8bl9u_.js"),[],import.meta.url),"../resources/adsb/adsb_3.png":()=>l(()=>import("./adsb_3-DJ1qKpzi.js"),[],import.meta.url),"../resources/adsb/adsb_4.png":()=>l(()=>import("./adsb_4-B9CxW2Pj.js"),[],import.meta.url),"../resources/adsb/adsb_5.png":()=>l(()=>import("./adsb_5-DzTGk9wg.js"),[],import.meta.url),"../resources/adsb/adsb_6.png":()=>l(()=>import("./adsb_6-Bkf57lbX.js"),[],import.meta.url),"../resources/adsb/adsb_7.png":()=>l(()=>import("./adsb_7-BSAwZApM.js"),[],import.meta.url),"../resources/adsb/adsb_8.png":()=>l(()=>import("./adsb_8-CVPxVgDj.js"),[],import.meta.url),"../resources/adsb/adsb_9.png":()=>l(()=>import("./adsb_9-Cb3621I0.js"),[],import.meta.url)}),`../resources/adsb/adsb_${E[i].iconNum}.png`,4)).default;f=(await l(async()=>{const{default:i}=await import("./cf_icon_position-DkF2qv43.js");return{default:i}},[],import.meta.url)).default}async function N(){const{default:i}=await l(async()=>{const{default:b}=await import("./gps-B97XKgrq.js");return{default:b}},[],import.meta.url);await J(),c.load(i,ne.processHtml(L))}let I=!1,G,h,D,y,m,v=!1,f;function L(){d.localize(),e.getFeatures(),K.updateUI(a(".tab-gps"),e.FEATURES);let i=a("#gps_port"),b=a("#gps_baud"),F=R.getPortIdentifiersForFunction("GPS"),r=null;F.length==1&&(r=F[0]);let g=R.getPortList();i.append('<option value="-1">NONE</option>');for(let t=0;t<g.length;t++){let s=g[t];i.append('<option value="'+s.identifier+'">'+s.displayName+"</option>")}if(R.getBauds("SENSOR").forEach(function(t){b.append('<option value="'+t+'">'+t+"</option>")}),r!==null){i.val(r);let t=R.getPortByIdentifier(r);b.val(t.sensors_baudrate)}else i.val(-1),b.val(R.getRuleByName("GPS").defaultBaud);var u=e.getGpsProtocols(),o=e.getGpsSbasProviders(),n=a("#gps_protocol");for(let t=0;t<u.length;t++)n.append('<option value="'+t+'">'+u[t]+"</option>");n.on("change",function(){e.MISC.gps_type=parseInt(a(this).val())}),n.val(e.MISC.gps_type),n.trigger("change");var U=a("#gps_ubx_sbas");for(let t=0;t<o.length;t++)U.append('<option value="'+t+'">'+o[t]+"</option>");U.on("change",function(){e.MISC.gps_ubx_sbas=parseInt(a(this).val())}),U.val(e.MISC.gps_ubx_sbas);let O=new Ae({center:[0,0],zoom:15}),M=[];p.mapProviderType=="esri"?(M.push(new k({source:new j({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attributions:'Source: <a href="https://www.esri.com/" target="_blank">Esri</a>, Maxar, Earthstar Geographics, and the GIS User Community',maxZoom:19})})),M.push(new k({source:new j({url:"https://services.arcgisonline.com/arcgis/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",maxZoom:19})})),M.push(new k({source:new j({url:"https://services.arcgisonline.com/arcgis/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",maxZoom:19})}))):p.mapProviderType=="mapproxy"?M.push(new k({source:new Te({url:p.proxyURL,params:{LAYERS:p.proxyLayer}})})):M.push(new k({source:new he})),a("#center_button").on("click",function(){let t=e.GPS_DATA.lat/1e7,s=e.GPS_DATA.lon/1e7,_=$([s,t]);O.setCenter(_)}),h=new be({target:"gps-map",layers:M,view:O}),x.gps.toolboxAdsbVehicle=new we("Mouse",{position:{x:"right",y:"bottom"},offset:{x:-5,y:20}}),h.on("pointermove",function(t){var s=h.forEachFeatureAtPixel(h.getEventPixel(t.originalEvent),function(_,S){return _});s&&s.get("data")&&s.get("name")?x.gps.toolboxAdsbVehicle.setContent("callsign: <strong>"+s.get("name")+"</strong><br />lat: <strong>"+s.get("data").lat/1e7+"</strong><br />lon: <strong>"+s.get("data").lon/1e7+"</strong><br />ASL: <strong>"+s.get("data").altCM/100+"m</strong><br />heading: <strong>"+s.get("data").headingDegrees+"Â°</strong><br />type: <strong>"+E[s.get("data").emitterType].name+"</strong>").open():x.gps.toolboxAdsbVehicle.close()});let ge=$([0,0]);O.setCenter(ge),O.setZoom(2);function _e(){H.send_message(B.MSP_RAW_GPS,!1,!1,fe)}function fe(){H.send_message(B.MSP_COMP_GPS,!1,!1,me)}function me(){H.send_message(B.MSP_GPSSTATISTICS,!1,!1,te)}function ve(){H.send_message(B.MSP2_ADSB_VEHICLE_LIST,!1,!1,Se)}function te(){let t=e.GPS_DATA.lat/1e7,s=e.GPS_DATA.lon/1e7,_=d.getMessage("gpsFixNone");e.GPS_DATA.fix>=2?_=d.getMessage("gpsFix3D"):e.GPS_DATA.fix>=1&&(_=d.getMessage("gpsFix2D")),a(".GPS_info td.fix").html(_),a(".GPS_info td.alt").text(e.GPS_DATA.alt+" m"),a(".GPS_info td.lat").text(t.toFixed(4)+" deg"),a(".GPS_info td.lon").text(s.toFixed(4)+" deg"),a(".GPS_info td.speed").text(e.GPS_DATA.speed+" cm/s"),a(".GPS_info td.sats").text(e.GPS_DATA.numSat),a(".GPS_info td.distToHome").text(e.GPS_DATA.distanceToHome+" m");let S=0;if(e.GPS_DATA.messageDt>0&&(S=1e3/e.GPS_DATA.messageDt),a(".GPS_stat td.messages").text(e.GPS_DATA.packetCount),a(".GPS_stat td.rate").text(S.toFixed(1)+" Hz"),a(".GPS_stat td.errors").text(e.GPS_DATA.errors),a(".GPS_stat td.timeouts").text(e.GPS_DATA.timeouts),a(".GPS_stat td.eph").text((e.GPS_DATA.eph/100).toFixed(2)+" m"),a(".GPS_stat td.epv").text((e.GPS_DATA.epv/100).toFixed(2)+" m"),a(".GPS_stat td.hdop").text((e.GPS_DATA.hdop/100).toFixed(2)),e.GPS_DATA.fix>=2){let w=$([s,t]);if(!I){I=!0,G=new ie({image:new le({anchor:[.5,1],opacity:1,scale:.5,src:f})});let C;D=new ue($([0,0])),y=new ce({geometry:D}),y.setStyle(G);let z=new pe({features:[y]});C=new de({source:z}),h.addLayer(C),O.setCenter(w),O.setZoom(14)}D.setCoordinates(w)}}function Se(){v&&m.clear(),a(".adsbVehicleTotalMessages").html(e.ADSB_VEHICLES.vehiclePacketCount),a(".adsbHeartbeatTotalMessages").html(e.ADSB_VEHICLES.heartbeatPacketCount);for(let t in e.ADSB_VEHICLES.vehicles){let s=e.ADSB_VEHICLES.vehicles[t];if(!v){v=!0,m=new pe({});let _=new de({source:m});h.addLayer(_)}if(s.lat!=0&&s.lon!=0&&s.ttl>0){let _=new ie({image:new le({opacity:1,rotation:s.headingDegrees*(Math.PI/180),scale:.8,anchor:[.5,.5],src:E[s.emitterType].icon}),text:new De({text:s.callsign,textAlign:"center",textBaseline:"bottom",offsetY:40,padding:[2,2,2,2],backgroundFill:"#444444",fill:new ye({color:"#ffffff"})})}),S=new ue($([s.lon/1e7,s.lat/1e7])),w=new ce({geometry:S,name:s.callsign,type:"adsb",data:s});w.setStyle(_),m.addFeature(w)}}}re.add("gps_pull",function(){if(!Pe.have_sensor(e.CONFIG.activeSensors,"gps")){te();return}_e()},200),xe.gte(e.CONFIG.flightControllerVersion,"8.0.0")&&(a(".adsb_info_block").hide(),P.loadSerialPorts(function(){for(var t in e.SERIAL_CONFIG.ports)if(e.SERIAL_CONFIG.ports[t].functions&&e.SERIAL_CONFIG.ports[t].functions.includes("TELEMETRY_MAVLINK")){a(".adsb_info_block").show(),re.add("adsb_pull",ve,200);break}})),a("a.save").on("click",function(){R.set(i.val(),"GPS",b.val()),K.reset(),K.fromUI(a(".tab-gps")),K.execute(function(){V.execute()})});function se(t){if(t!=null){let S=0,w=t.length;var s=X(),_=[];let C=new Date;c.log(d.getMessage("gpsAssistnowStart")),t.forEach(z=>{_.push(function(ae){let oe=!1;Q.isAssistnowDataRelevant(z,C.getUTCFullYear(),C.getUTCMonth()+1,C.getUTCDate()+1)?P.sendUbloxCommand(z,ae):oe=!0,S++,S%100==0&&c.log(S+"/"+w+" "+d.getMessage("gpsAssistnowUpdate")),oe&&ae()})}),s.setChain(_),s.setExitPoint(function(){S%100!=0&&c.log(S+"/"+w+" "+d.getMessage("gpsAssistnowUpdate")),c.log(d.getMessage("gpsAssistnowDone"))}),s.execute()}}a("a.loadAssistnowOnline").on("click",function(){p.assistnowApiKey!=null&&p.assistnowApiKey!=""?Q.loadAssistnowOnline(se):ee.alert("Assistnow Token not set!")}),a("a.loadAssistnowOffline").on("click",function(){p.assistnowApiKey!=null&&p.assistnowApiKey!=""?Q.loadAssistnowOffline(se):ee.alert("Assistnow Token not set!")}),c.content_ready(A)}};x.gps.cleanup=function(A){A&&A(),x.gps.toolboxAdsbVehicle&&x.gps.toolboxAdsbVehicle.close()};
